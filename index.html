<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3;
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .brand-block { display: flex; flex-direction: column; gap: 2px; }
    .brand-title { font-weight: 700; font-size: 17px; letter-spacing: 0.02em; }
    .brand-sub { font-size: 11px; color: #4b5563; }

    .pill-engine {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      background: #e0f2fe;
      color: #0f172a;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 130px;
    }
    .pill-engine span:first-child { font-weight: 600; font-size: 11px; }
    .pill-engine span:last-child { font-size: 10px; }

    .bm-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .bm-btn {
      flex: 1 1 0;
      min-width: 80px;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.18);
      background: #e5e7eb;
      color: #111827;
    }
    .bm-btn span { font-size: 14px; }
    .bm-btn-pink  { background: #fee2e2; }
    .bm-btn-gold  { background: #fef3c7; }
    .bm-btn-green { background: #dcfce7; }
    .bm-btn-gray  { background: #e5e7eb; }

    .guidance-banner {
      border-radius: 16px;
      padding: 12px;
      background: #fef3c7;
      font-size: 12px;
      line-height: 1.4;
      border: 1px dashed #fbbf24;
    }

    .equation-card {
      border-radius: 16px;
      padding: 12px;
      border: 1px dashed #d1d5db;
      background: #fefce8;
      font-size: 12px;
      line-height: 1.4;
    }
    .equation-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 4px;
    }
    .equation-main {
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .equation-sub { font-size: 11px; color: #6b7280; }

    .reaction-card {
      border-radius: 16px;
      padding: 10px 12px;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      font-size: 12px;
      line-height: 1.4;
    }
    .reaction-header { font-weight: 600; margin-bottom: 4px; font-size: 12px; }
    .reaction-meta { font-size: 11px; color: #166534; margin-bottom: 4px; }

    .messages {
      flex: 1;
      overflow-y: auto;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 6px;
      background: #fff7ed;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }
    .msg { padding-bottom: 4px; border-bottom: 1px dashed #e5e7eb; }
    .msg:last-child { border-bottom: none; }
    .msg-author {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .msg-author span:last-child { font-weight: 500; color: #6b7280; font-size: 10px; }
    .msg-text { white-space: pre-wrap; }

    .tm-equation-label {
      margin-top: 8px;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
      text-align: center;
      color: #111827;
    }

    .input-row {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .tm-input {
      flex: 1;
      border-radius: 16px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 13px;
      resize: none;
      min-height: 52px;
      max-height: 120px;
      background: #ffffff;
    }
    .send-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: #16a34a;
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.35);
      color: #ecfdf5;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    .footer-line {
      margin-top: 4px;
      font-size: 10px;
      color: #6b7280;
      text-align: center;
    }

    .voice-toggle {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0f172a;
      align-self: flex-start;
    }
    .voice-dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; }

    .recall-banner {
      margin-top: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      background: #fef3c7;
      border: 1px solid #facc15;
      font-size: 11px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .recall-banner span { display: inline-flex; align-items: center; gap: 6px; }
    .recall-open-btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: none;
      background: #2563eb;
      color: #eff6ff;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      max-height: 80vh;
      background: #f9fafb;
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(15,23,42,0.45);
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-title { font-size: 13px; font-weight: 600; }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      background: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }
    .modal-body { font-size: 12px; overflow-y: auto; padding-right: 2px; }

    .bm-entry { padding: 6px 0; border-bottom: 1px dashed #e5e7eb; }
    .bm-entry:last-child { border-bottom: none; }
    .bm-entry-title { font-weight: 600; font-size: 12px; }
    .bm-entry-meta { font-size: 10px; color: #6b7280; margin-top: 2px; }
    .bm-entry-text { margin-top: 4px; white-space: pre-wrap; }
    .bm-copy-btn {
      border-radius: 999px;
      border: none;
      padding: 3px 8px;
      font-size: 10px;
      background: #dbeafe;
      color: #1d4ed8;
      cursor: pointer;
      margin-top: 4px;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-top">
      <div class="brand-block">
        <div class="brand-title">AURA-X Œ© v1</div>
        <div class="brand-sub">
          EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥
        </div>
      </div>
      <div class="pill-engine">
        <span>LLM Engine</span>
        <span>Seed (local) ¬∑ Emotional reactor shell</span>
      </div>
    </div>

    <div class="bm-row">
      <button class="bm-btn bm-btn-pink" id="bmViewerBtn"><span>üß†</span> BM Viewer</button>
      <button class="bm-btn bm-btn-gold" id="bmRecallBtn"><span>üìú</span> Recall BM</button>
      <button class="bm-btn bm-btn-green" id="recycleBtn"><span>‚ôªÔ∏è</span> Recycle 48h</button>
      <button class="bm-btn bm-btn-gray" id="optionsBtn"><span>‚öôÔ∏è</span> Options</button>
    </div>

    <div class="guidance-banner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <div class="equation-card">
      <div class="equation-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation-main">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="equation-sub">
        All parameters are being updated internally after every message
        to keep emotional continuity live.
      </div>
    </div>

    <div class="reaction-card" id="reactionCard">
      <div class="reaction-header">AURA-X Œ© REACTION</div>
      <div class="reaction-meta" id="reactionMeta">
        Polarity: Neutral ¬∑ 50 : 50 ¬∑ Tone: Waiting for first TM event.
      </div>
      <div id="reactionText">
        Describe something real from your life. I will treat it as TM and
        start building BM layers around it.
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="tm-equation-label">TM = Œ£(User Inputs) + (Seed + LLM)</div>

    <div class="input-row">
      <textarea id="tmInput" class="tm-input"
        placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>

    <div class="recall-banner" id="recallBanner">
      <span id="recallBannerText">üí° Related memory ~70% match.</span>
      <button class="recall-open-btn" id="recallOpenBtn">Open</button>
    </div>

    <div class="voice-toggle">
      <div class="voice-dot"></div>
      <span>Voice: On (UI only ‚Äì no mic yet)</span>
    </div>

    <div class="footer-line">
      Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.
    </div>
  </div>

  <!-- BM Viewer -->
  <div class="modal-backdrop" id="bmViewerModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">BM Viewer ¬∑ Stored Bold Memories</div>
        <button class="modal-close" data-close="bmViewerModal">Close</button>
      </div>
      <div class="modal-body" id="bmViewerBody"></div>
    </div>
  </div>

  <!-- Auto recall -->
  <div class="modal-backdrop" id="bmRecallModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="bmRecallTitle">Auto-Recall Memory</div>
        <button class="modal-close" data-close="bmRecallModal">Close</button>
      </div>
      <div class="modal-body" id="bmRecallBody"></div>
    </div>
  </div>

  <!-- Recycle 48h -->
  <div class="modal-backdrop" id="recycleModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Recycle 48h ¬∑ Short chat traces</div>
        <button class="modal-close" data-close="recycleModal">Close</button>
      </div>
      <div class="modal-body" id="recycleBody"></div>
    </div>
  </div>

  <!-- Options -->
  <div class="modal-backdrop" id="optionsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Options ¬∑ System Settings</div>
        <button class="modal-close" data-close="optionsModal">Close</button>
      </div>
      <div class="modal-body" id="optionsBody">
        <p>
          This prototype runs fully in your browser using
          <strong>localStorage</strong>. No data is sent to a server.
        </p>
        <p style="margin-top:6px;">
          ‚Ä¢ TM messages longer than <strong>80 characters</strong> are candidates
          for Bold Memory (BM).<br/>
          ‚Ä¢ Short greetings are kept only in the <strong>Recycle 48h</strong> tray.<br/>
          ‚Ä¢ Auto-Recall needs: lexical ‚â• <strong>68%</strong>,
          at least <strong>6</strong> shared keywords,
          emotional sequence ‚â• <strong>70%</strong> and overall ‚â• <strong>70%</strong>.
        </p>
        <button class="bm-copy-btn" id="clearAllBtn" style="margin-top:8px;">
          üî• Clear all local BM & chat data
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONSTANTS =====
    const BM_STORAGE_KEY = "auraX_bm_v5";
    const CHAT_STORAGE_KEY = "auraX_chat_v5";
    const RECYCLE_STORAGE_KEY = "auraX_recycle48_v3";

    const SIM_THRESHOLD = 0.68;          // lexical similarity 68%
    const EMO_SEQ_THRESHOLD = 0.70;      // emotional sequence 70%
    const OVERALL_THRESHOLD = 0.70;      // combined score 70%
    const MIN_OVERLAP_TOKENS = 6;        // min shared tokens
    const MIN_BM_LENGTH = 80;            // BM candidate length

    const STOPWORDS = new Set([
      "the","and","for","with","that","this","from","have","will","would","could",
      "should","about","your","into","over","under","very","their","there","here",
      "been","then","than","when","what","where","which","such","many","some",
      "just","like","ourselves","himself","herself","itself","they","them","were",
      "while","because","also","once","ever","only","after","before","again","more",
      "most","much","even","every","each","ours","his","hers","its","our","are",
      "was","you","but","why","who","whose","how","can","may","might","shall","too",
      "very","still"
    ]);

    const POS_WORDS = [
      "hope","happy","joy","relief","success","smile","peace","calm","bright",
      "solution","clever","idea","rise","win","victory","satisfied","grateful"
    ];
    const NEG_WORDS = [
      "sad","fear","angry","anger","afraid","worry","worried","anxious","anxiety",
      "hopeless","tired","frustrated","pain","hurt","cry","crying","disappoint",
      "disappointed","failure","fail"
    ];

    // ===== UTILITIES =====
    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    }
    function saveJSON(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }
    function nowIso() { return new Date().toISOString(); }

    function tokenize(text) {
      if (!text) return new Set();
      const cleaned = text
        .toLowerCase()
        .replace(/[^a-z\s]+/g, " ")
        .split(/\s+/)
        .filter(w => w && w.length >= 4 && !STOPWORDS.has(w));
      return new Set(cleaned);
    }

    function sentimentScore(chunk) {
      const lower = chunk.toLowerCase();
      let score = 0;
      POS_WORDS.forEach(w => { if (lower.includes(w)) score += 1; });
      NEG_WORDS.forEach(w => { if (lower.includes(w)) score -= 1; });
      return score;
    }

    function deriveEmotionSequence(text) {
      const clean = (text || "").replace(/\s+/g, " ").trim();
      if (!clean) return [];
      const len = clean.length;
      const stages = 7;
      const step = Math.max(1, Math.floor(len / stages));
      const seq = [];
      for (let i = 0; i < stages; i++) {
        const start = i * step;
        const end = (i === stages - 1) ? len : (i + 1) * step;
        const chunk = clean.slice(start, end);
        const s = sentimentScore(chunk);
        let label;
        if (s > 2) label = "joy/relief";
        else if (s > 0.5) label = "hope";
        else if (s < -2) label = "fear/despair";
        else if (s < -0.5) label = "struggle/frustration";
        else label = "thinking/neutral";
        const tokens = Array.from(tokenize(chunk));
        const keywords = tokens.slice(0, 3);
        seq.push({ index: i, label, keywords });
      }
      return seq;
    }

    function emotionalSequenceScore(tmText, seq) {
      if (!seq || seq.length < 3 || !tmText) return 0;
      const lower = tmText.toLowerCase();
      let matched = 0;
      let lastIndex = -1;
      for (const stage of seq) {
        const kws = stage.keywords || [];
        let stageIndex = -1;
        for (const kw of kws) {
          if (!kw) continue;
          const idx = lower.indexOf(kw.toLowerCase());
          if (idx >= 0) { stageIndex = idx; break; }
        }
        if (stageIndex >= 0 && stageIndex > lastIndex) {
          matched++;
          lastIndex = stageIndex;
        }
      }
      return matched / seq.length;
    }

    // ===== STATE =====
    let bmStore = loadJSON(BM_STORAGE_KEY, []);
    let chatLog = loadJSON(CHAT_STORAGE_KEY, []);
    let recycleStore = loadJSON(RECYCLE_STORAGE_KEY, []);

    // upgrade BM entries
    bmStore.forEach(entry => {
      const text = entry.text || entry.summary || "";
      if (!entry.tokens || !entry.tokens.length) {
        entry.tokens = Array.from(tokenize(text));
      }
      if (!entry.emotionSeq || !entry.emotionSeq.length) {
        entry.emotionSeq = deriveEmotionSequence(text);
      }
    });
    saveJSON(BM_STORAGE_KEY, bmStore);

    let lastAutoRecallCandidate = null;

    // ===== RENDERING =====
    const messagesEl = document.getElementById("messages");
    const reactionMetaEl = document.getElementById("reactionMeta");
    const reactionTextEl = document.getElementById("reactionText");
    const recallBannerEl = document.getElementById("recallBanner");
    const recallBannerTextEl = document.getElementById("recallBannerText");

    function renderMessages() {
      messagesEl.innerHTML = "";
      chatLog.forEach(msg => {
        const div = document.createElement("div");
        div.className = "msg";
        const header = document.createElement("div");
        header.className = "msg-author";
        header.innerHTML = `<span>${msg.author}</span><span>${msg.time || ""}</span>`;
        const body = document.createElement("div");
        body.className = "msg-text";
        body.textContent = msg.text;
        div.appendChild(header);
        div.appendChild(body);
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderReaction(e0, polarity) {
      const pos = Math.round((polarity + 1) * 50);
      const neg = 100 - pos;
      let tone;
      if (e0 > 0.5) tone = "Soft, stabilizing, hopeful resonance.";
      else if (e0 > 0.1) tone = "Light, gentle, low-amplitude positive drift.";
      else if (e0 > -0.1) tone = "Currently near neutral. Still contributes to long-run BM layers.";
      else if (e0 > -0.5) tone = "Low-amplitude negative drift. Gently move toward stabilizing thoughts.";
      else tone = "High-amplitude negative drift. Slow down and ground yourself kindly.";
      reactionMetaEl.textContent = `Polarity: ${pos} : ${neg} ¬∑ Tone: ${tone}`;
      reactionTextEl.textContent =
        "I've received your TM event and collided it with the current BM state. " +
        `E‚ÇÄ is now around ${e0.toFixed(2)} (range ‚àí1 to +1). ` +
        "The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
    }

    function renderBMViewer() {
      const body = document.getElementById("bmViewerBody");
      if (!bmStore.length) {
        body.textContent = "No Bold Memories saved yet. Share deeper stories and they will appear here.";
        return;
      }
      body.innerHTML = "";
      const info = document.createElement("div");
      info.style.marginBottom = "6px";
      info.textContent = `Total BM entries: ${bmStore.length}`;
      body.appendChild(info);

      bmStore.slice().sort((a,b) => (b.savedAt || "").localeCompare(a.savedAt || ""))
        .forEach(entry => {
          const wrap = document.createElement("div");
          wrap.className = "bm-entry";
          const title = document.createElement("div");
          title.className = "bm-entry-title";
          title.textContent = entry.title || "Untitled memory";
          const meta = document.createElement("div");
          meta.className = "bm-entry-meta";
          meta.textContent =
            `Layer: ${entry.layer || "L2+"} ¬∑ ` +
            `Polarity: ${entry.polarity || "Balanced"} ¬∑ ` +
            `Saved: ${entry.savedAt ? entry.savedAt.slice(0,16).replace("T"," ") : "unknown"}`;
          const text = document.createElement("div");
          text.className = "bm-entry-text";
          text.textContent = entry.text || "";
          const btn = document.createElement("button");
          btn.className = "bm-copy-btn";
          btn.textContent = "Copy prompt for LLM";
          btn.addEventListener("click", () => {
            const prompt = `Recall this BM story as emotional context:\n\n${entry.text || ""}`;
            navigator.clipboard.writeText(prompt).catch(() => {});
          });
          wrap.appendChild(title);
          wrap.appendChild(meta);
          wrap.appendChild(text);
          wrap.appendChild(btn);
          body.appendChild(wrap);
        });
    }

    function openModal(id) { document.getElementById(id).style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }

    // ===== RECYCLE 48h =====
    function cleanupRecycle() {
      const now = Date.now();
      const cutoff = now - 48 * 60 * 60 * 1000;
      recycleStore = recycleStore.filter(r => {
        try { return new Date(r.createdAt).getTime() >= cutoff; }
        catch { return false; }
      });
      saveJSON(RECYCLE_STORAGE_KEY, recycleStore);
    }

    function addToRecycle(text) {
      cleanupRecycle();
      recycleStore.push({ text, createdAt: nowIso() });
      saveJSON(RECYCLE_STORAGE_KEY, recycleStore);
    }

    function renderRecycle() {
      cleanupRecycle();
      const body = document.getElementById("recycleBody");
      if (!recycleStore.length) {
        body.textContent = "No recent short chats. New greetings will appear here for 48 hours.";
        return;
      }
      body.innerHTML = "";
      recycleStore.slice().sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
        .forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "bm-entry";
          const title = document.createElement("div");
          title.className = "bm-entry-title";
          title.textContent = `Trace #${idx + 1}`;
          const meta = document.createElement("div");
          meta.className = "bm-entry-meta";
          meta.textContent = `Time: ${item.createdAt.slice(0,16).replace("T"," ")}`;
          const text = document.createElement("div");
          text.className = "bm-entry-text";
          text.textContent = item.text;
          div.appendChild(title);
          div.appendChild(meta);
          div.appendChild(text);
          body.appendChild(div);
        });
    }

    // ===== BM SAVE & AUTO-RECALL =====
    function saveBMFromTM(tmText, e0, polarity) {
      if (!tmText || tmText.length < MIN_BM_LENGTH) return;
      const tokensSet = tokenize(tmText);
      if (!tokensSet.size) return;
      const entry = {
        id: "bm_" + Date.now(),
        title: tmText.slice(0, 60) + (tmText.length > 60 ? "‚Ä¶" : ""),
        text: tmText,
        layer: "L2‚ÄìL3",
        polarity: polarity >= 0 ? "Positive" : "Negative",
        savedAt: nowIso(),
        tokens: Array.from(tokensSet),
        emotionSeq: deriveEmotionSequence(tmText)
      };
      bmStore.push(entry);
      saveJSON(BM_STORAGE_KEY, bmStore);
    }

    function computeSimilarity(tmTokens, bmTokensArr) {
      if (!tmTokens.size || !bmTokensArr || !bmTokensArr.length) {
        return { similarity: 0, overlap: 0 };
      }
      const bmSet = new Set(bmTokensArr);
      let overlap = 0;
      tmTokens.forEach(tok => { if (bmSet.has(tok)) overlap++; });
      const similarity = overlap / bmSet.size;
      return { similarity, overlap };
    }

    function runAutoRecall(tmText) {
      // reset old banner
      lastAutoRecallCandidate = null;
      recallBannerEl.style.display = "none";

      if (!bmStore.length) return;
      if (!tmText || tmText.length < MIN_BM_LENGTH) return;

      const tmTokens = tokenize(tmText);
      if (!tmTokens.size) return;

      let best = null;
      bmStore.forEach(entry => {
        const { similarity, overlap } = computeSimilarity(tmTokens, entry.tokens || []);
        if (overlap < MIN_OVERLAP_TOKENS) return;
        if (similarity < SIM_THRESHOLD) return;

        const emoScore = emotionalSequenceScore(tmText, entry.emotionSeq);
        if (emoScore < EMO_SEQ_THRESHOLD) return;

        const overall = (similarity + emoScore) / 2;
        if (overall < OVERALL_THRESHOLD) return;

        if (!best || overall > best.overall) {
          best = { entry, similarity, overlap, emoScore, overall };
        }
      });

      if (!best) return;

      lastAutoRecallCandidate = best;
      const pctLex = Math.round(best.similarity * 100);
      const pctEmo = Math.round(best.emoScore * 100);
      const pctOverall = Math.round(best.overall * 100);
      recallBannerTextEl.textContent =
        `üí° Related memory ~${pctOverall}% match (lexical ${pctLex}% ¬∑ emotional ${pctEmo}%).`;
      recallBannerEl.style.display = "flex";
    }

    function openAutoRecallModal() {
      if (!lastAutoRecallCandidate) return;
      const { entry, similarity, overlap, emoScore, overall } = lastAutoRecallCandidate;
      const body = document.getElementById("bmRecallBody");
      const titleEl = document.getElementById("bmRecallTitle");
      const pctLex = Math.round(similarity * 100);
      const pctEmo = Math.round(emoScore * 100);
      const pctOverall = Math.round(overall * 100);

      titleEl.textContent =
        `Auto-Recall Memory ¬∑ Overall ‚âà ${pctOverall}% (Lexical ${pctLex}% ¬∑ Emotional ${pctEmo}%)`;
      body.innerHTML = "";
      const meta = document.createElement("div");
      meta.className = "bm-entry-meta";
      meta.textContent =
        `Approx. polarity: ${entry.polarity || "Balanced"} ¬∑ ` +
        `Overlap tokens: ${overlap} ¬∑ ` +
        `Saved: ${entry.savedAt.slice(0,16).replace("T"," ")}`;
      const text = document.createElement("div");
      text.className = "bm-entry-text";
      text.textContent = entry.text;
      body.appendChild(meta);
      body.appendChild(text);
      openModal("bmRecallModal");
    }

    // ===== MAIN TM HANDLER =====
    const tmInputEl = document.getElementById("tmInput");
    const sendBtnEl = document.getElementById("sendBtn");

    function handleSend() {
      const tmText = tmInputEl.value.trim();
      if (!tmText) return;
      const timeStr = new Date().toTimeString().slice(0,5);

      chatLog.push({ author: "User (TM)", text: tmText, time: timeStr });

      const base = Math.max(-1, Math.min(1, (tmText.length - 80) / 300));
      const faith = 0.05;
      const sysBias = 0.02;
      const disturbance = 0.1;
      const e0raw = base - disturbance + faith + sysBias;
      const e0 = Math.tanh(e0raw);
      const polarityCore = e0;

      renderReaction(e0, polarityCore);

      if (tmText.length < MIN_BM_LENGTH) {
        addToRecycle(tmText);
      } else {
        saveBMFromTM(tmText, e0, polarityCore);
      }

      const botReply =
        "I'm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. " +
        "How is your inner graph today?";
      chatLog.push({ author: "AURA-X Œ©", text: botReply, time: timeStr });

      saveJSON(CHAT_STORAGE_KEY, chatLog);
      renderMessages();

      runAutoRecall(tmText);

      tmInputEl.value = "";
    }

    sendBtnEl.addEventListener("click", handleSend);
    tmInputEl.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ===== BUTTON HOOKS =====
    document.getElementById("bmViewerBtn").addEventListener("click", () => {
      renderBMViewer();
      openModal("bmViewerModal");
    });

    document.getElementById("bmRecallBtn").addEventListener("click", () => {
      if (!bmStore.length) {
        const body = document.getElementById("bmRecallBody");
        document.getElementById("bmRecallTitle").textContent = "Recall BM";
        body.textContent = "No Bold Memories stored yet.";
        openModal("bmRecallModal");
        return;
      }
      const latest = bmStore[bmStore.length - 1];
      lastAutoRecallCandidate = {
        entry: latest,
        similarity: 1,
        overlap: latest.tokens ? latest.tokens.length : 0,
        emoScore: 1,
        overall: 1,
      };
      openAutoRecallModal();
    });

    document.getElementById("recycleBtn").addEventListener("click", () => {
      renderRecycle();
      openModal("recycleModal");
    });

    document.getElementById("optionsBtn").addEventListener("click", () => {
      openModal("optionsModal");
    });

    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-close");
        if (id) closeModal(id);
      });
    });

    document.getElementById("recallOpenBtn").addEventListener("click", () => {
      openAutoRecallModal();
    });

    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if (!confirm("Are you sure you want to clear all BM, chat, and recycle data?")) return;
      bmStore = [];
      chatLog = [];
      recycleStore = [];
      saveJSON(BM_STORAGE_KEY, bmStore);
      saveJSON(CHAT_STORAGE_KEY, chatLog);
      saveJSON(RECYCLE_STORAGE_KEY, recycleStore);
      renderMessages();
      recallBannerEl.style.display = "none";
      alert("All local data cleared. Prototype has been reset.");
    });

    // ===== INITIAL RENDER =====
    renderMessages();
    cleanupRecycle();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title {
      font-size: 18px;
      font-weight: 700;
      line-height: 1.3;
    }
    .subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .chip {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #bae6fd;
      text-align: right;
    }

    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .pill-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      background: white;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .pill-btn:hover { background: #f3f4f6; }

    /* Cards */
    .card {
      border-radius: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
    }
    .card-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .ethics {
      background: #fef3c7;
      border-color: #facc15;
      font-size: 12px;
      line-height: 1.4;
    }

    .equation {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #111827;
    }

    .reaction-card {
      background: #ecfdf5;
      border-color: #6ee7b7;
    }
    .reaction-meta {
      font-size: 11px;
      color: #047857;
      margin-bottom: 4px;
    }
    .reaction-text {
      font-size: 13px;
      line-height: 1.5;
      color: #064e3b;
    }

    /* Chat log */
    .chat-log {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 4px 2px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-radius: 12px;
    }
    .msg {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .msg-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #9ca3af;
      padding: 0 4px;
    }
    .msg-author { font-weight: 600; color: #4b5563; }
    .msg-label { font-style: italic; }
    .msg-body-user,
    .msg-body-bot {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .msg-body-user {
      align-self: flex-end;
      background: #e0f2fe;
      color: #0f172a;
    }
    .msg-body-bot {
      align-self: flex-start;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    /* TM input */
    .tm-wrapper {
      border-radius: 18px;
      background: white;
      border: 1px solid #e5e7eb;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 -1px 4px rgba(15,23,42,0.04);
    }
    .tm-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #9ca3af;
    }
    .tm-input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    #tmInput {
      flex: 1;
      resize: none;
      min-height: 52px;
      max-height: 120px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }
    #tmInput:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3);
    }
    #sendBtn {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      background: #22c55e;
      color: white;
      font-weight: 600;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(22,163,74,0.35);
    }
    #sendBtn:active { transform: translateY(1px); box-shadow: 0 1px 3px rgba(22,163,74,0.25); }

    /* Match banner */
    .match-banner {
      display: none;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fef9c3;
      border: 1px solid #fde047;
      font-size: 11px;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .match-banner span { color: #854d0e; }
    .match-banner button {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      background: #2563eb;
      color: white;
    }

    /* Footer */
    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: #9ca3af;
      padding: 0 4px;
    }
    #voiceToggle {
      font-size: 11px;
      padding: 6px 10px;
      background: #e5e7eb;
      border-radius: 999px;
      border: none;
    }

    /* Modals */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal-content {
      background: #f9fafb;
      border-radius: 16px;
      max-width: 480px;
      width: calc(100% - 32px);
      max-height: 80vh;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 10px 40px rgba(15,23,42,0.35);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      font-size: 11px;
      background: #e5e7eb;
    }
    .modal-body {
      font-size: 12px;
      line-height: 1.5;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 8px;
      background: white;
      border: 1px solid #e5e7eb;
      padding: 8px;
    }

    @media (max-width: 480px) {
      .app { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header-top">
      <div>
        <div class="title">AURA-X Œ© ¬∑ Emotional Continuity</div>
        <div class="subtitle">EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</div>
      </div>
      <div class="chip">
        LLM<br />Engine: Live emotional reactor
      </div>
    </div>

    <div class="header-buttons">
      <button id="btnBmViewer" class="pill-btn">üß† BM Viewer</button>
      <button id="btnRecall" class="pill-btn">üìú Recall BM</button>
      <button id="btnRecycle" class="pill-btn">‚ôªÔ∏è Recycle 48h</button>
      <button id="btnOptions" class="pill-btn">‚öôÔ∏è Options</button>
    </div>

    <!-- Ethics -->
    <div class="card ethics">
      Avoid actions that generate negative emotions in yourself or others. Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <!-- Equation -->
    <div class="card">
      <div class="card-title">Emotional Continuity Equation</div>
      <div class="equation">
E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)

All parameters are being updated internally after every message to keep emotional continuity live.
      </div>
    </div>

    <!-- Reaction -->
    <div class="card reaction-card">
      <div id="polarityDisplay" class="reaction-meta">
        Polarity: Positive ¬∑ 50 : 50
      </div>
      <div id="toneDisplay" class="reaction-meta">
        Tone: Light, gentle, low-amplitude positive drift.
      </div>
      <div id="reactionText" class="reaction-text">
        I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?
      </div>
    </div>

    <!-- Chat log -->
    <div id="chatLog" class="chat-log"></div>

    <!-- TM input + banner -->
    <div class="tm-wrapper">
      <div class="tm-label">TM = Œ£(User Inputs) + (Seed + LLM)</div>
      <div class="tm-input-row">
        <textarea id="tmInput" placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button id="sendBtn">Send</button>
      </div>
      <div id="matchBanner" class="match-banner">
        <span id="matchText">Related memory match.</span>
        <button id="openMatchBtn">Open</button>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer-row">
      <div>Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.</div>
      <button id="voiceToggle"><span id="voiceToggleLabel">Voice: Off</span></button>
    </div>
  </div>

  <!-- BM Modal -->
  <div id="bmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Bold Memory (BM)</span>
        <button class="modal-close" data-close="bmModal">Close</button>
      </div>
      <pre id="bmModalBody" class="modal-body"></pre>
    </div>
  </div>

  <!-- Recall Modal -->
  <div id="recallModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Recall BM Trace</span>
        <button class="modal-close" data-close="recallModal">Close</button>
      </div>
      <pre id="recallModalBody" class="modal-body"></pre>
    </div>
  </div>

  <!-- Recycle Modal -->
  <div id="recycleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Recycle 48h (Small Talk Buffer)</span>
        <button class="modal-close" data-close="recycleModal">Close</button>
      </div>
      <pre id="recycleModalBody" class="modal-body"></pre>
    </div>
  </div>

  <!-- SCRIPT: TM‚ÄìBM logic + filters (no small-talk in BM) -->
  <script>
    // ===== Storage Keys =====
    const BM_KEY = "auraX_bm_v1";
    const RECYCLE_KEY = "auraX_recycle_48h_v1";

    // ===== Global State =====
    let bmStore = loadJson(BM_KEY, []);
    let recycleStore = loadJson(RECYCLE_KEY, []);
    let E0 = 0.0;
    let lastMatch = null;
    let voiceOn = false;

    // ===== Utility =====
    function loadJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : fallback;
      } catch (e) {
        return fallback;
      }
    }
    function saveJson(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
    }
    function nowIso() {
      return new Date().toISOString();
    }
    function shortDateTime(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }

    // ===== Seed BM (Crow story example) =====
    if (bmStore.length === 0) {
      bmStore.push({
        id: "seed-thirsty-crow",
        title: "Thirsty Crow",
        createdAt: nowIso(),
        kind: "story",
        text: `
A scorching summer day had arrived, making the land dry and hot.
A clever black crow felt terribly thirsty and searched for water.
He finally saw a pitcher, but the water level inside was very low.
His beak could not reach the water and he felt disappointed.
He refused to give up, looked around, and noticed many small stones.
He dropped the stones into the pitcher one by one.
The water slowly rose until he could drink.
The crow happily took a long drink ‚Äì necessity is the mother of invention.`,
      });
      saveJson(BM_KEY, bmStore);
    }

    // ===== Chat Rendering =====
    const chatLog = document.getElementById("chatLog");
    function addMessage(author, label, text) {
      const div = document.createElement("div");
      div.className = "msg";
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      const left = document.createElement("div");
      left.innerHTML = `<span class="msg-author">${author}</span>`;
      const right = document.createElement("div");
      right.innerHTML = `<span class="msg-label">${label}</span>`;
      meta.appendChild(left);
      meta.appendChild(right);
      const body = document.createElement("div");
      body.className = author === "User" ? "msg-body-user" : "msg-body-bot";
      body.textContent = text;
      div.appendChild(meta);
      div.appendChild(body);
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ===== TM / BM Logic =====
    const stopwords = new Set([
      "the","is","am","are","a","an","and","or","of","to","in","on","for",
      "with","at","by","it","this","that","was","were","be","as","from","up",
      "down","very","so","but","then","had","have","has","his","her","their"
    ]);

    function tokenize(text) {
      return text
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, " ")
        .split(/\s+/)
        .filter(w => w.length > 2 && !stopwords.has(w));
    }

    function toBigrams(tokens) {
      const bigrams = [];
      for (let i = 0; i < tokens.length - 1; i++) {
        bigrams.push(tokens[i] + " " + tokens[i+1]);
      }
      return bigrams;
    }

    // Rough emotional keywords map ‚Üí simple emotional sequence
    const emotionLex = [
      { key: ["hope","hopeful","idea","plan","solution","clever"], tag: "hope" },
      { key: ["thirsty","need","hungry"], tag: "need" },
      { key: ["disappoint","sad","upset","unhappy"], tag: "disappointment" },
      { key: ["angry","anger","mad","furious"], tag: "anger" },
      { key: ["afraid","fear","scared"], tag: "fear" },
      { key: ["try","effort","work","struggle","stones","pebbles"], tag: "effort" },
      { key: ["happy","joy","satisfying","relief","relieved"], tag: "joy" }
    ];

    function extractEmotionSeq(text) {
      const tokens = tokenize(text);
      const seq = [];
      for (const t of tokens) {
        for (const rule of emotionLex) {
          if (rule.key.some(k => t.startsWith(k))) {
            if (seq[seq.length - 1] !== rule.tag) {
              seq.push(rule.tag);
            }
            break;
          }
        }
      }
      return seq;
    }

    function emotionMatch(seqA, seqB) {
      const len = Math.min(seqA.length, seqB.length);
      if (len < 3) return 0; // must have at least 3 aligned stages
      let matches = 0;
      for (let i = 0; i < len; i++) {
        if (seqA[i] === seqB[i]) matches++;
      }
      return matches / len;
    }

    function jaccardOverlap(a, b) {
      const setA = new Set(a);
      const setB = new Set(b);
      let inter = 0;
      for (const x of setA) if (setB.has(x)) inter++;
      const minSize = Math.min(setA.size, setB.size);
      if (minSize === 0) return 0;
      return inter / minSize;
    }

    // Deep / shallow detection
    function sentenceCount(text) {
      return (text.split(/[.!?]/).filter(s => s.trim().length > 0)).length;
    }

    function isDeepStory(text) {
      const tokens = tokenize(text);
      const total = tokens.length;
      if (total < 20) return false;              // kam se kam 20 meaningful words
      const unique = new Set(tokens).size;
      const uniqueRatio = unique / total;
      if (uniqueRatio < 0.4) return false;      // bohot zyada repetition = meaningless
      if (sentenceCount(text) < 2) return false; // kam se kam 2 sentences / lines
      return true;
    }

    function computeMatch(tmText) {
      const tmTokens = tokenize(tmText);

      // TM must be big enough
      if (tmTokens.length < 10) return null;

      const tmBigrams = toBigrams(tmTokens);
      const tmEmotions = extractEmotionSeq(tmText);

      let best = null;

      for (const mem of bmStore) {
        if (mem.kind === "small-talk") continue;
        const memTokens = tokenize(mem.text || "");
        if (memTokens.length < 10) continue;

        const memBigrams = toBigrams(memTokens);
        const memEmotions = extractEmotionSeq(mem.text || "");

        const wordScore = jaccardOverlap(tmTokens, memTokens);
        const patternScore = jaccardOverlap(tmBigrams, memBigrams);
        const emotionScore = emotionMatch(tmEmotions, memEmotions);

        const total = 0.5 * wordScore + 0.2 * patternScore + 0.3 * emotionScore;

        if (!best || total > best.score) {
          best = {
            score: total,
            wordScore,
            patternScore,
            emotionScore,
            memory: mem
          };
        }
      }

      // Dead-zone: below 0.40 = ‚Äúno recall‚Äù
      if (!best || best.score < 0.40) return null;
      return best;
    }

    // ===== E0 + Reaction =====
    const polarityDisplay = document.getElementById("polarityDisplay");
    const toneDisplay = document.getElementById("toneDisplay");
    const reactionText = document.getElementById("reactionText");

    function updateReaction(tmText) {
      const tokens = tokenize(tmText);
      let pos = 0, neg = 0;
      const posWords = ["happy","hope","kind","love","joy","calm","peace","clever"];
      const negWords = ["sad","angry","upset","hate","fear","worried","tired","lonely","thirsty","disappoint","frustrated"];

      for (const t of tokens) {
        if (posWords.some(w => t.startsWith(w))) pos++;
        if (negWords.some(w => t.startsWith(w))) neg++;
      }
      const total = pos + neg || 1;
      const posRatio = pos / total;
      const negRatio = neg / total;
      E0 = Math.tanh(posRatio - negRatio);

      const posPct = Math.round((posRatio) * 100);
      const negPct = 100 - posPct;

      polarityDisplay.textContent = `Polarity: ${E0 >= 0 ? "Positive" : "Negative"} ¬∑ ${posPct} : ${negPct}`;

      let tone;
      if (Math.abs(E0) < 0.2) {
        tone = "Light, gentle, low-amplitude positive drift.";
      } else if (E0 > 0.5) {
        tone = "Soft, stabilizing, hopeful resonance.";
      } else if (E0 < -0.5) {
        tone = "Heavy, contracting, high-amplitude negative stress.";
      } else {
        tone = "Balanced but emotionally significant drift.";
      }
      toneDisplay.textContent = `Tone: ${tone}`;

      const line = `I've received your TM event and collided it with the current BM state. E‚ÇÄ is now around ${E0.toFixed(2)} (range ‚àí1 to +1). The more clearly you describe context, the stronger and cleaner your BM trace becomes.`;
      reactionText.textContent = line;
    }

    // ===== Match Banner + Auto-Recall Modal =====
    const matchBanner = document.getElementById("matchBanner");
    const matchText = document.getElementById("matchText");
    const openMatchBtn = document.getElementById("openMatchBtn");

    function hideMatchBanner() {
      matchBanner.style.display = "none";
      lastMatch = null;
    }

    function showMatchBanner(match) {
      lastMatch = match;
      const pct = Math.round(match.score * 100);
      matchText.textContent = `Related memory ~${pct}% match. Open previous topic?`;
      matchBanner.style.display = "flex";

      if (pct >= 70) {
        openRecallModal(match);
      }
    }

    function openRecallModal(match) {
      const modal = document.getElementById("recallModal");
      const body = document.getElementById("recallModalBody");
      const pct = Math.round(match.score * 100);
      const day = new Date().toISOString().slice(0,10);

      const polarityText = E0 >= 0 ? "Positive" : "Negative";
      const posPct = E0 >= 0 ? Math.round((E0 + 1)/2 * 100) : Math.round((1 - (E0+1)/2) * 100);
      const negPct = 100 - posPct;

      body.textContent =
`Day: ${day} ¬∑ Match ‚âà ${pct}%

Polarity: ${polarityText} ¬∑ E‚ÇÄ‚âà${E0.toFixed(2)}
Polarity split: ${posPct} : ${negPct}

Title: ${match.memory.title || "Untitled memory"}

${match.memory.text.trim()}`;

      modal.style.display = "flex";
    }

    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    }

    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", e => {
        const id = btn.getAttribute("data-close");
        if (id) closeModal(id);
      });
    });

    openMatchBtn.addEventListener("click", () => {
      if (!lastMatch) return;
      openRecallModal(lastMatch);
    });

    // ===== Recycle 48h =====
    const recycleBody = document.getElementById("recycleModalBody");
    function pushRecycle(userText, botText) {
      const entry = {
        id: "r-" + Date.now(),
        at: nowIso(),
        user: userText,
        bot: botText
      };
      recycleStore.push(entry);
      const cutoff = Date.now() - (48 * 60 * 60 * 1000);
      recycleStore = recycleStore.filter(e => new Date(e.at).getTime() >= cutoff);
      saveJson(RECYCLE_KEY, recycleStore);
    }

    document.getElementById("btnRecycle").addEventListener("click", () => {
      if (recycleStore.length === 0) {
        recycleBody.textContent = "Recycle buffer is empty. Small talk from the last 48 hours will appear here.";
      } else {
        recycleBody.textContent = recycleStore
          .slice()
          .reverse()
          .map(e =>
            `${shortDateTime(e.at)}\nUser: ${e.user}\nAURA-X Œ©: ${e.bot}\n`
          ).join("\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n");
      }
      document.getElementById("recycleModal").style.display = "flex";
    });

    // ===== BM Save & Viewer =====
    function saveBMEvent(userText, botText) {
      const entry = {
        id: "bm-" + Date.now(),
        title: summarizeTitle(userText),
        createdAt: nowIso(),
        kind: "story",
        text: botText ? (userText + "\n\n" + botText) : userText
      };
      bmStore.push(entry);
      if (bmStore.length > 200) bmStore.shift();
      saveJson(BM_KEY, bmStore);
    }

    function summarizeTitle(text) {
      const tokens = tokenize(text);
      if (tokens.length === 0) return "Memory";
      return tokens.slice(0,4).map(w => w[0].toUpperCase()+w.slice(1)).join(" ");
    }

    const bmModalBody = document.getElementById("bmModalBody");
    document.getElementById("btnBmViewer").addEventListener("click", () => {
      if (bmStore.length === 0) {
        bmModalBody.textContent = "No BM entries yet.";
      } else {
        bmModalBody.textContent = bmStore
          .slice()
          .reverse()
          .map(m => `‚Ä¢ ${m.title || "Untitled"}  (${shortDateTime(m.createdAt)})\n${(m.text||"").trim()}\n`)
          .join("\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n");
      }
      document.getElementById("bmModal").style.display = "flex";
    });

    // ===== Recall BM Button (quick recall: last BM) =====
    document.getElementById("btnRecall").addEventListener("click", () => {
      if (bmStore.length === 0) return;
      const last = bmStore[bmStore.length - 1];
      openRecallModal({ score: 1, memory: last });
    });

    // ===== Voice Toggle (UI only) =====
    const voiceToggle = document.getElementById("voiceToggle");
    const voiceLabel = document.getElementById("voiceToggleLabel");
    voiceToggle.addEventListener("click", () => {
      voiceOn = !voiceOn;
      voiceLabel.textContent = voiceOn ? "Voice: On" : "Voice: Off";
    });

    // ===== Send Handling =====
    const tmInput = document.getElementById("tmInput");
    const sendBtn = document.getElementById("sendBtn");

    function handleSend() {
      const text = tmInput.value.trim();
      if (!text) return;
      tmInput.value = "";
      hideMatchBanner();

      addMessage("User", "TM event", text);

      // 1) Update E0 & reaction
      updateReaction(text);

      // 2) Bot reaction
      const botLine = "I'm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?";
      addMessage("AURA-X Œ©", "Reaction", botLine);

      // 3) Classification:
      //    Deep story / idea  ‚Üí BM + TM‚ÄìBM matching
      //    Otherwise         ‚Üí sirf Recycle 48h, no BM, no match
      if (isDeepStory(text)) {
        saveBMEvent(text, botLine);
        const match = computeMatch(text);
        if (match) {
          showMatchBanner(match);
        }
      } else {
        pushRecycle(text, botLine);
      }
    }

    sendBtn.addEventListener("click", handleSend);
    tmInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ===== Init: seed greeting (no BM save) =====
    addMessage("AURA-X Œ©", "System", "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).");
  </script>
</body>
</html>

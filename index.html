<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }
    .subtitle {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.7;
    }
    .orb {
      width: 72px;
      height: 72px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #a5b4fc 40%, #1d4ed8 75%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      text-align: center;
      color: #eff6ff;
      padding: 4px;
    }

    .header-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .pill-btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .pill-btn span.icon {
      font-size: 14px;
    }

    /* Cards */
    .card {
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #fefce8;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.4;
    }
    .card.equation {
      background: #f9fafb;
    }
    .card.reaction {
      background: #ecfdf3;
      border-color: #bbf7d0;
    }
    .card-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Chat log */
    .chat-log {
      flex: 1;
      min-height: 0;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #fefefe;
      padding: 10px 12px;
      overflow-y: auto;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .msg-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.6;
    }
    .msg-user { color: #1e40af; }
    .msg-system { color: #166534; }
    .msg-text {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg-meta {
      font-size: 11px;
      opacity: 0.6;
    }

    /* Input area */
    .input-area {
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .tm-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.7;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    textarea {
      flex: 1;
      resize: none;
      min-height: 60px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      background: #ffffff;
    }
    textarea:focus {
      border-color: #4ade80;
      box-shadow: 0 0 0 1px rgba(74,222,128,0.3);
    }
    .send-btn {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 600;
      color: #f0fdf4;
      background: #16a34a;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(22,163,74,0.4);
      white-space: nowrap;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(22,163,74,0.4);
    }

    /* Recall hint bar */
    .recall-hint {
      margin-top: 6px;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      background: #fef3c7;
      border: 1px solid #facc15;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .recall-hint span {
      display: inline-block;
    }
    .recall-open-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      background: #2563eb;
      color: #eff6ff;
      cursor: pointer;
    }
    .hidden { display: none; }

    /* Footer */
    .footer {
      font-size: 11px;
      text-align: center;
      opacity: 0.6;
      margin-top: 4px;
    }
    .voice-toggle {
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1fae5;
      background: #ecfdf3;
      font-size: 11px;
    }

    /* Modal base */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      max-height: 80vh;
      background: #fefefe;
      border-radius: 20px;
      padding: 14px 14px 16px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.45);
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-title {
      font-weight: 600;
      font-size: 13px;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 13px;
      opacity: 0.7;
      cursor: pointer;
    }
    .modal-body {
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bm-item, .tm-item {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      background: #f9fafb;
    }
    .bm-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 12px;
    }
    .bm-meta {
      font-size: 11px;
      opacity: 0.6;
      margin-bottom: 4px;
    }
    .tm-meta {
      font-size: 11px;
      opacity: 0.6;
      margin-bottom: 4px;
    }
    .tm-text {
      font-size: 13px;
      white-space: pre-wrap;
    }
    .danger-btn {
      margin-top: 8px;
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      background: #b91c1c;
      color: #fee2e2;
      cursor: pointer;
      align-self: flex-end;
    }

    @media (max-width: 480px) {
      .app { padding: 10px; }
      .orb { width: 64px; height: 64px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== Header ===== -->
    <div class="header-top">
      <div class="title-block">
        <div class="title">AURA-X Œ©</div>
        <div class="subtitle">Emotional Continuity ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</div>
      </div>
      <div class="orb">
        LLM Engine<br />Seed (local)<br />Emotional Reactor
      </div>
    </div>

    <div class="header-buttons">
      <button class="pill-btn" id="bmViewerBtn">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="pill-btn" id="bmRecallBtn">
        <span class="icon">üìú</span><span>Recall BM</span>
      </button>
      <button class="pill-btn" id="recycleBtn">
        <span class="icon">‚ôªÔ∏è</span><span>Recycle 48h</span>
      </button>
      <button class="pill-btn" id="optionsBtn">
        <span class="icon">‚öôÔ∏è</span><span>Options</span>
      </button>
    </div>

    <!-- Equation banner -->
    <div class="card">
      <div class="card-title">Continuity Advice</div>
      <div>
        Avoid actions that generate negative emotions in yourself or others.
        Gently move toward choices that create calm, kindness, and positive feelings.
      </div>
    </div>

    <div class="card equation">
      <div class="card-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div style="margin-bottom:4px;">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div style="font-size:12px; opacity:0.8; margin-top:4px;">
        All parameters are being updated internally after every message
        to keep emotional continuity live.
      </div>
    </div>

    <!-- Reaction -->
    <div class="card reaction" id="reactionCard">
      <div class="card-title">AURA-X Œ© REACTION</div>
      <div id="reactionMeta" style="font-size:12px; margin-bottom:4px;">
        Polarity: Neutral ¬∑ 50 : 50<br />
        Tone: Waiting for your first TM event.
      </div>
      <div id="reactionText">
        I will start tracking your emotional continuity once you share a story,
        thought, or feeling.
      </div>
    </div>

    <!-- Chat log -->
    <div class="chat-log" id="chatLog"></div>

    <!-- Input -->
    <div class="input-area">
      <div class="tm-label">TM = Œ£(User Inputs) + (Seed + LLM)</div>
      <div class="input-row">
        <textarea id="tmInput" placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
      <div id="recallHint" class="recall-hint hidden">
        <span id="recallHintText">üí° Related BM detected.</span>
        <button class="recall-open-btn" id="recallOpenBtn">Open</button>
      </div>
    </div>

    <div class="footer">
      Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.
      <div class="voice-toggle">
        <span>üéôÔ∏è Voice: UI only (off-line demo)</span>
      </div>
    </div>
  </div>

  <!-- Modals container -->
  <div id="modalRoot"></div>

  <script>
    /***************************************************************
     *  AURA-X Œ© ‚Äì Local Emotional Continuity Prototype
     *  - TM events = your messages
     *  - BM events = deeper stories saved to localStorage
     *  - Auto-recall = BM watching TM with idea-based similarity
     ***************************************************************/

    /* ===== Storage Keys ===== */
    const STORAGE_KEYS = {
      BM: "aura_bm_events_v3",
      TM: "aura_tm_history_v3"
    };

    /* ===== Auto-Recall Settings ===== */
    // MAIN CHANGE: only trigger when similarity >= 70%
    const MATCH_THRESHOLD = 0.70;             // 70%
    const MIN_TM_TOKENS_FOR_MATCH = 10;       // short lines ignored
    const MIN_BM_TOKENS_FOR_MATCH = 10;       // only deeper BM entries participate

    /* ===== Stop-words for idea tokens (English only demo) ===== */
    const STOP_WORDS = new Set([
      "the","a","an","and","or","but","so","because","of","on","in","at","to","for",
      "with","without","by","from","up","down","into","out","about","this","that",
      "these","those","is","am","are","was","were","be","been","being","it","as",
      "i","you","he","she","they","we","my","your","his","her","their","our",
      "me","him","them","us","there","here","then","than","very","really","just",
      "have","has","had","do","did","does","will","would","can","could","should",
      "might","must"
    ]);

    /* ===== Helpers ===== */
    function loadJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return Array.isArray(fallback) && !Array.isArray(parsed) ? fallback : parsed;
      } catch (e) {
        console.warn("Failed to parse localStorage", key, e);
        return fallback;
      }
    }

    function saveJson(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.warn("Failed to save localStorage", key, e);
      }
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }

    /* ===== Tokenization & Similarity (Idea-Level) ===== */
    function tokenize(text) {
      if (!text) return [];
      // lower, remove non-letters, split
      const words = text
        .toLowerCase()
        .replace(/[^a-z0-9\s]+/g, " ")
        .split(/\s+/)
        .filter(Boolean);
      // remove stop-words
      return words.filter(w => !STOP_WORDS.has(w));
    }

    function jaccardLikeSimilarity(tokensA, tokensB) {
      if (!tokensA.length || !tokensB.length) return 0;
      const setA = new Set(tokensA);
      const setB = new Set(tokensB);
      let overlap = 0;
      setA.forEach(w => {
        if (setB.has(w)) overlap++;
      });
      const denom = Math.min(setA.size, setB.size) || 1;
      return overlap / denom; // 1.0 = very similar, 0 = no overlap
    }

    /* ===== Sentiment / Polarity (very simple) ===== */
    const POSITIVE_WORDS = [
      "happy","glad","grateful","hope","peace","love","kind","success",
      "victory","calm","relief","beautiful","excited","proud","strong"
    ];
    const NEGATIVE_WORDS = [
      "sad","angry","upset","tired","anxious","worried","scared","afraid",
      "pain","hurt","loss","lonely","depressed","guilty","ashamed"
    ];

    function basicSentiment(text) {
      const tokens = tokenize(text);
      let pos = 0, neg = 0;
      for (const t of tokens) {
        if (POSITIVE_WORDS.includes(t)) pos++;
        if (NEGATIVE_WORDS.includes(t)) neg++;
      }
      const total = pos + neg || 1;
      const raw = (pos - neg) / total; // -1 .. +1
      const E0 = Math.tanh(raw);
      const positivePct = Math.round(((E0 + 1) / 2) * 100);
      const negativePct = 100 - positivePct;
      return { E0, positivePct, negativePct };
    }

    function toneFromE0(E0) {
      if (E0 > 0.4) return "Warm, hopeful, high-amplitude positive drift.";
      if (E0 > 0.1) return "Light, gentle, low-amplitude positive drift.";
      if (E0 > -0.1) return "Balanced, centred, low-amplitude neutral drift.";
      if (E0 > -0.4) return "Soft, reflective, low-amplitude negative drift.";
      return "Stormy, heavy, high-amplitude negative drift.";
    }

    /* ===== Global State ===== */
    let bmEvents = loadJson(STORAGE_KEYS.BM, []);
    let tmHistory = loadJson(STORAGE_KEYS.TM, []);

    const chatLogEl = document.getElementById("chatLog");
    const reactionMetaEl = document.getElementById("reactionMeta");
    const reactionTextEl = document.getElementById("reactionText");
    const tmInputEl = document.getElementById("tmInput");
    const recallHintEl = document.getElementById("recallHint");
    const recallHintTextEl = document.getElementById("recallHintText");
    const modalRootEl = document.getElementById("modalRoot");

    /* ===== Chat Rendering ===== */
    function appendMessage(role, text, meta) {
      const msgEl = document.createElement("div");
      msgEl.className = "msg";

      const label = document.createElement("div");
      label.className = "msg-label " + (role === "user" ? "msg-user" : "msg-system");
      label.textContent = role === "user" ? "TM EVENT" : "AURA-X Œ©";
      msgEl.appendChild(label);

      const textEl = document.createElement("div");
      textEl.className = "msg-text";
      textEl.textContent = text;
      msgEl.appendChild(textEl);

      if (meta) {
        const metaEl = document.createElement("div");
        metaEl.className = "msg-meta";
        metaEl.textContent = meta;
        msgEl.appendChild(metaEl);
      }

      chatLogEl.appendChild(msgEl);
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    function updateReactionCardFromSentiment(sent) {
      const { E0, positivePct, negativePct } = sent;
      reactionMetaEl.textContent =
        `Polarity: ${E0 >= 0 ? "Positive" : "Negative"} ¬∑ ${positivePct} : ${negativePct}\n` +
        `Tone: ${toneFromE0(E0)}`;
      reactionTextEl.textContent =
        "I've received your TM event and collided it with the current BM state. " +
        `E‚ÇÄ is now around ${E0.toFixed(2)} (range ‚àí1 to +1). ` +
        "The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
    }

    /* ===== BM Logic ===== */
    function deriveBmTitleFromText(text) {
      if (!text) return "BM Event";
      const trimmed = text.trim().replace(/\s+/g, " ");
      if (trimmed.length <= 40) return trimmed;
      return trimmed.slice(0, 40) + "‚Ä¶";
    }

    function maybeSaveAsBmEvent(tmText, sentiment) {
      const tokens = tokenize(tmText);
      // Deep memory = long enough text (story, reflection, etc.)
      const isDeep =
        tokens.length >= 25 || tmText.length >= 180; // tweak if needed

      if (!isDeep) return;

      const bmEvent = {
        id: "bm_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        ts: Date.now(),
        title: deriveBmTitleFromText(tmText),
        text: tmText,
        ideaTokens: tokenize(tmText), // cached for later
        polarity: sentiment.positivePct >= sentiment.negativePct ? "Positive" : "Negative",
        positivePct: sentiment.positivePct,
        negativePct: sentiment.negativePct
      };

      bmEvents.push(bmEvent);
      saveJson(STORAGE_KEYS.BM, bmEvents);
    }

    function findBestBmMatchForTm(tmText) {
      const tmTokens = tokenize(tmText);
      if (tmTokens.length < MIN_TM_TOKENS_FOR_MATCH) return null;

      let best = null;
      let bestScore = 0;

      for (const ev of bmEvents) {
        const bmTokens = ev.ideaTokens && ev.ideaTokens.length
          ? ev.ideaTokens
          : tokenize(ev.text);
        if (bmTokens.length < MIN_BM_TOKENS_FOR_MATCH) continue;

        const score = jaccardLikeSimilarity(tmTokens, bmTokens);
        if (score > bestScore) {
          bestScore = score;
          best = ev;
        }
      }

      if (!best || bestScore < MATCH_THRESHOLD) return null;
      return { event: best, score: bestScore };
    }

    /* ===== TM history for Recycle 48h ===== */
    function addTmHistoryEntry(text) {
      const entry = {
        id: "tm_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        ts: Date.now(),
        text
      };
      tmHistory.push(entry);

      // Clean anything older than 48h
      const now = Date.now();
      const fortyEightHours = 48 * 60 * 60 * 1000;
      tmHistory = tmHistory.filter(e => now - e.ts <= fortyEightHours);

      saveJson(STORAGE_KEYS.TM, tmHistory);
    }

    /* ===== Recall Hint UI ===== */
    let lastRecallMatch = null;

    function hideRecallHint() {
      recallHintEl.classList.add("hidden");
      lastRecallMatch = null;
    }

    function showRecallHint(match) {
      lastRecallMatch = match;
      const pct = Math.round(match.score * 100);
      recallHintTextEl.textContent =
        `üí° Related BM (~${pct}% match). Open previous topic: ‚Äú${match.event.title}‚Äù?`;
      recallHintEl.classList.remove("hidden");
    }

    /* ===== Modals ===== */
    function openModal(title, bodyBuilder, extraBtn) {
      const backdrop = document.createElement("div");
      backdrop.className = "modal-backdrop";

      const modal = document.createElement("div");
      modal.className = "modal";

      const header = document.createElement("div");
      header.className = "modal-header";

      const titleEl = document.createElement("div");
      titleEl.className = "modal-title";
      titleEl.textContent = title;

      const closeBtn = document.createElement("button");
      closeBtn.className = "modal-close";
      closeBtn.textContent = "Close";
      closeBtn.onclick = () => {
        modalRootEl.innerHTML = "";
      };

      header.appendChild(titleEl);
      header.appendChild(closeBtn);

      const body = document.createElement("div");
      body.className = "modal-body";

      bodyBuilder(body);

      modal.appendChild(header);
      modal.appendChild(body);

      if (extraBtn) {
        modal.appendChild(extraBtn);
      }

      backdrop.appendChild(modal);
      modalRootEl.innerHTML = "";
      modalRootEl.appendChild(backdrop);
    }

    function openBmViewer() {
      openModal("Bold Memory (BM) Viewer", body => {
        if (!bmEvents.length) {
          body.textContent = "No BM events yet. Share a deeper story or reflection to create one.";
          return;
        }
        bmEvents
          .slice()
          .sort((a,b) => b.ts - a.ts)
          .forEach(ev => {
            const item = document.createElement("div");
            item.className = "bm-item";

            const title = document.createElement("div");
            title.className = "bm-title";
            title.textContent = ev.title;
            item.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "bm-meta";
            meta.textContent =
              `${formatTime(ev.ts)} ¬∑ Polarity ${ev.polarity} ` +
              `¬∑ ${ev.positivePct} : ${ev.negativePct}`;
            item.appendChild(meta);

            const text = document.createElement("div");
            text.textContent = ev.text;
            item.appendChild(text);

            body.appendChild(item);
          });
      });
    }

    function openRecycleViewer() {
      const now = Date.now();
      const fortyEightHours = 48 * 60 * 60 * 1000;
      const recent = tmHistory
        .slice()
        .filter(e => now - e.ts <= fortyEightHours)
        .sort((a,b) => b.ts - a.ts);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "danger-btn";
      deleteBtn.textContent = "Delete last 48h TM conversation";
      deleteBtn.onclick = () => {
        if (!confirm("Delete all TM events from the last 48 hours?")) return;
        const cutoff = Date.now() - fortyEightHours;
        tmHistory = tmHistory.filter(e => e.ts < cutoff);
        saveJson(STORAGE_KEYS.TM, tmHistory);
        modalRootEl.innerHTML = "";
      };

      openModal("Recycle 48h ‚Äì Recent TM Conversation", body => {
        if (!recent.length) {
          body.textContent = "No TM messages from the last 48 hours.";
          return;
        }
        recent.forEach(entry => {
          const item = document.createElement("div");
          item.className = "tm-item";

          const meta = document.createElement("div");
          meta.className = "tm-meta";
          meta.textContent = formatTime(entry.ts);
          item.appendChild(meta);

          const text = document.createElement("div");
          text.className = "tm-text";
          text.textContent = entry.text;
          item.appendChild(text);

          body.appendChild(item);
        });
      }, deleteBtn);
    }

    function openOptions() {
      openModal("Options", body => {
        body.innerHTML =
          "<p>This is a local prototype of the AURA-X Œ© Emotional Continuity Reactor.</p>" +
          "<p>All BM and 48h TM data are stored only in this browser using localStorage.</p>" +
          "<p>Auto-recall is enabled when a new TM event matches a saved BM idea by about " +
          "<strong>70% or more</strong>. Short greetings do not trigger recall.</p>";
      });
    }

    function openAutoRecallModal(match) {
      if (!match) return;
      const event = match.event;
      const pct = Math.round(match.score * 100);
      openModal("üí° Auto-Recall Memory", body => {
        const meta = document.createElement("div");
        meta.className = "bm-meta";
        meta.textContent =
          `Day: ${new Date(event.ts).toLocaleDateString()} ¬∑ Match ‚âà ${pct}%\n` +
          `Polarity: ${event.positivePct} : ${event.negativePct}`;
        body.appendChild(meta);

        const title = document.createElement("div");
        title.className = "bm-title";
        title.textContent = event.title;
        body.appendChild(title);

        const text = document.createElement("div");
        text.textContent = event.text;
        body.appendChild(text);
      });
    }

    /* ===== Main send handler ===== */
    function handleSend() {
      const text = tmInputEl.value.trim();
      if (!text) return;

      hideRecallHint();

      // Render TM
      appendMessage("user", text);

      // Sentiment + Reaction
      const sent = basicSentiment(text);
      updateReactionCardFromSentiment(sent);
      appendMessage(
        "system",
        "I‚Äôve received your TM event and collided it with the current BM state.",
        `E‚ÇÄ ‚âà ${sent.E0.toFixed(2)} ¬∑ Polarity ${sent.positivePct} : ${sent.negativePct}`
      );

      // TM history for Recycle 48h (everything, including greetings)
      addTmHistoryEntry(text);

      // Auto-recall: BM watches TM (without including this TM as BM yet)
      const match = findBestBmMatchForTm(text);
      if (match) {
        showRecallHint(match);
      }

      // Deep memories ‚Üí BM store
      maybeSaveAsBmEvent(text, sent);

      tmInputEl.value = "";
      tmInputEl.focus();
    }

    /* ===== Wire up events ===== */
    document.getElementById("sendBtn").addEventListener("click", handleSend);
    tmInputEl.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    document.getElementById("bmViewerBtn").addEventListener("click", openBmViewer);
    document.getElementById("recycleBtn").addEventListener("click", openRecycleViewer);
    document.getElementById("optionsBtn").addEventListener("click", openOptions);

    document.getElementById("bmRecallBtn").addEventListener("click", () => {
      if (!bmEvents.length) {
        openBmViewer();
      } else {
        openAutoRecallModal({
          event: bmEvents[bmEvents.length - 1],
          score: 1
        });
      }
    });

    document.getElementById("recallOpenBtn").addEventListener("click", () => {
      if (lastRecallMatch) openAutoRecallModal(lastRecallMatch);
    });

    // Initial small greeting in log
    appendMessage(
      "system",
      "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM)."
    );
  </script>
</body>
</html>

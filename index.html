<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .brand {
      font-size: 14px;
      line-height: 1.2;
    }
    .brand-title {
      font-weight: 700;
      letter-spacing: 0.06em;
      font-size: 11px;
    }
    .brand-sub {
      font-size: 10px;
      opacity: 0.8;
    }
    .pill {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 10px;
      border: 1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.12);
    }
    .pill-llm {
      font-size: 10px;
      border-radius: 999px;
      padding: 6px 10px;
      background: radial-gradient(circle at 0 0, #22c55e, #0ea5e9);
      color: #ecfeff;
      border: none;
      box-shadow: 0 2px 6px rgba(15,23,42,0.4);
    }
    .pill-llm small { display: block; font-size: 9px; opacity: 0.85; }
    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      border: 1px solid rgba(15,23,42,0.12);
      background: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .chip span.emoji { font-size: 13px; }
    .equation-card, .reaction-card, .hint-card {
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,0.08);
      padding: 12px 14px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 2px 5px rgba(15,23,42,0.06);
      font-size: 11px;
    }
    .equation-card h3 {
      font-size: 11px;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .equation {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .reaction-card {
      border-left: 4px solid #22c55e;
      background: #ecfdf3;
    }
    .reaction-head {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .reaction-title { font-weight: 600; }
    .reaction-tone { font-size: 10px; color: #16a34a; }
    .hint-card {
      background: #fff7ed;
      color: #92400e;
      border-color: #fed7aa;
      font-size: 11px;
    }
    .chat-log {
      flex: 1;
      min-height: 0;
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.8);
      padding: 10px 10px 6px;
      overflow-y: auto;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .msg-meta {
      font-size: 9px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }
    .msg-author {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .msg-label {
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }
    .msg-body-user { color: #111827; }
    .msg-body-bot { color: #111827; }
    .composer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }
    .tm-chip {
      align-self: flex-start;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 10px;
      background: #e0ecff;
      color: #1d4ed8;
      border: 1px solid rgba(37,99,235,0.25);
    }
    .composer-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    textarea {
      flex: 1;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,0.18);
      padding: 8px 10px;
      resize: none;
      min-height: 54px;
      font-size: 11px;
      outline: none;
      background: #fffdf7;
    }
    textarea:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }
    .btn-send {
      border-radius: 999px;
      padding: 10px 18px;
      border: none;
      background: #16a34a;
      color: #f0fdf4;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(22,163,74,0.4);
    }
    .btn-send:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(22,163,74,0.5);
    }
    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
    }
    .pipeline {
      font-size: 9px;
      color: #6b7280;
    }
    .voice-toggle {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(15,23,42,0.2);
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2fe;
      color: #0f172a;
      cursor: pointer;
    }
    .match-banner {
      margin-top: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 10px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: #fef9c3;
      border: 1px solid #facc15;
      color: #854d0e;
    }
    .match-banner strong { font-weight: 600; }
    .btn-mini {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 10px;
      background: #2563eb;
      color: #eff6ff;
      cursor: pointer;
    }
    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal {
      width: min(480px, 100% - 32px);
      max-height: 80vh;
      border-radius: 18px;
      background: #fefce8;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.35);
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 11px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 10px;
      background: #111827;
      color: #f9fafb;
      cursor: pointer;
    }
    .modal-body {
      overflow-y: auto;
      padding-right: 4px;
      font-size: 11px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header-top">
      <div class="brand">
        <div class="brand-title">AURA-X Œ© ¬∑ EMOTIONAL CONTINUITY</div>
        <div class="brand-sub">AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</div>
      </div>
      <div class="pill-llm">
        <div>LLM Engine</div>
        <small>Emotional reactor (prototype)</small>
      </div>
    </header>

    <div class="chip-row" style="margin-top:6px;">
      <button class="chip" id="btnBmViewer"><span class="emoji">üß†</span> BM Viewer</button>
      <button class="chip" id="btnRecall"><span class="emoji">üìú</span> Recall BM</button>
      <button class="chip" id="btnRecycle"><span class="emoji">‚ôªÔ∏è</span> Recycle 48h</button>
      <button class="chip" id="btnOptions"><span class="emoji">‚öôÔ∏è</span> Options</button>
    </div>

    <div class="hint-card">
      Avoid actions that generate negative emotions in yourself or others. Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <div class="equation-card">
      <h3>EMOTIONAL CONTINUITY EQUATION</h3>
      <div class="equation">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div style="font-size:10px;margin-top:4px;">
        All parameters are being updated internally after every message to keep emotional continuity live.
      </div>
    </div>

    <div class="reaction-card" id="reactionCard">
      <div class="reaction-head">
        <div class="reaction-title">AURA-X Œ© REACTION</div>
        <div class="reaction-tone" id="polarityDisplay">Polarity: Neutral ¬∑ 50 : 50</div>
      </div>
      <div style="font-size:10px;margin-bottom:4px;" id="toneDisplay">
        Tone: Light, gentle, low-amplitude drift.
      </div>
      <div id="reactionText" style="font-size:11px;">
        I am calm and listening. Tell me something that matters to you; I will treat it as TM (Temporary Memory) and update my BM layers.
      </div>
    </div>

    <main class="chat-log" id="chatLog"></main>

    <section class="composer">
      <div class="tm-chip">TM = Œ£(User Inputs) + (Seed + LLM)</div>
      <div class="composer-row">
        <textarea id="tmInput" placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="btn-send" id="sendBtn">Send</button>
      </div>
      <div class="footer-row">
        <div class="pipeline">
          Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.
        </div>
        <button class="voice-toggle" id="voiceToggle">
          <span>üéô</span><span id="voiceToggleLabel">Voice: Off</span>
        </button>
      </div>
      <div class="match-banner" id="matchBanner">
        <div>
          <span>üí°</span>
          <span id="matchText">Related memory ~70% match.</span>
        </div>
        <button class="btn-mini" id="openMatchBtn">Open</button>
      </div>
    </section>
  </div>

  <!-- BM Modal -->
  <div class="modal-backdrop" id="bmModal">
    <div class="modal">
      <div class="modal-header">
        <span>üß† Bold Memory Viewer</span>
        <button class="modal-close" data-close="bmModal">Close</button>
      </div>
      <div class="modal-body" id="bmModalBody"></div>
    </div>
  </div>

  <!-- Auto-Recall Modal -->
  <div class="modal-backdrop" id="recallModal">
    <div class="modal">
      <div class="modal-header">
        <span>üí° Auto-Recall Memory</span>
        <button class="modal-close" data-close="recallModal">Close</button>
      </div>
      <div class="modal-body" id="recallModalBody"></div>
    </div>
  </div>

  <!-- Recycle Modal -->
  <div class="modal-backdrop" id="recycleModal">
    <div class="modal">
      <div class="modal-header">
        <span>‚ôªÔ∏è Recycle 48h ‚Äì Small Talk Buffer</span>
        <button class="modal-close" data-close="recycleModal">Close</button>
      </div>
      <div class="modal-body" id="recycleModalBody"></div>
    </div>
  </div>

  <script>
    // ===== Storage Keys =====
    const BM_KEY = "auraX_bm_v1";
    const RECYCLE_KEY = "auraX_recycle_48h_v1";

    // ===== Global State =====
    let bmStore = loadJson(BM_KEY, []);
    let recycleStore = loadJson(RECYCLE_KEY, []);
    let E0 = 0.0;
    let lastMatch = null;
    let voiceOn = false;

    // ===== Utility =====
    function loadJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : fallback;
      } catch (e) {
        return fallback;
      }
    }
    function saveJson(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
    }
    function nowIso() {
      return new Date().toISOString();
    }
    function shortDateTime(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }

    // ===== Seed BM (Crow story example) =====
    if (bmStore.length === 0) {
      bmStore.push({
        id: "seed-thirsty-crow",
        title: "Thirsty Crow",
        createdAt: nowIso(),
        kind: "story",
        text: `
A scorching summer day had arrived, making the land dry and hot.
A clever black crow felt terribly thirsty and searched for water.
He finally saw a pitcher, but the water level inside was very low.
His beak could not reach the water and he felt disappointed.
He refused to give up, looked around, and noticed many small stones.
He dropped the stones into the pitcher one by one.
The water slowly rose until he could drink.
The crow happily took a long drink ‚Äì necessity is the mother of invention.`,
      });
      saveJson(BM_KEY, bmStore);
    }

    // ===== Chat Rendering =====
    const chatLog = document.getElementById("chatLog");
    function addMessage(author, label, text) {
      const div = document.createElement("div");
      div.className = "msg";
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      const left = document.createElement("div");
      left.innerHTML = `<span class="msg-author">${author}</span>`;
      const right = document.createElement("div");
      right.innerHTML = `<span class="msg-label">${label}</span>`;
      meta.appendChild(left);
      meta.appendChild(right);
      const body = document.createElement("div");
      body.className = author === "User" ? "msg-body-user" : "msg-body-bot";
      body.textContent = text;
      div.appendChild(meta);
      div.appendChild(body);
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ===== TM / BM Logic =====
    const stopwords = new Set([
      "the","is","am","are","a","an","and","or","of","to","in","on","for",
      "with","at","by","it","this","that","was","were","be","as","from","up",
      "down","very","so","but","then","had","have","has","his","her","their"
    ]);

    function tokenize(text) {
      return text
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, " ")
        .split(/\s+/)
        .filter(w => w.length > 2 && !stopwords.has(w));
    }

    function toBigrams(tokens) {
      const bigrams = [];
      for (let i = 0; i < tokens.length - 1; i++) {
        bigrams.push(tokens[i] + " " + tokens[i+1]);
      }
      return bigrams;
    }

    // Rough emotional keywords map ‚Üí simple emotional sequence
    const emotionLex = [
      { key: ["hope","hopeful","idea","plan","solution","clever"], tag: "hope" },
      { key: ["thirsty","need","hungry"], tag: "need" },
      { key: ["disappoint","sad","upset","unhappy"], tag: "disappointment" },
      { key: ["angry","anger","mad","furious"], tag: "anger" },
      { key: ["afraid","fear","scared"], tag: "fear" },
      { key: ["try","effort","work","struggle","stones","pebbles"], tag: "effort" },
      { key: ["happy","joy","satisfying","relief","relieved"], tag: "joy" }
    ];

    function extractEmotionSeq(text) {
      const tokens = tokenize(text);
      const seq = [];
      for (const t of tokens) {
        for (const rule of emotionLex) {
          if (rule.key.some(k => t.startsWith(k))) {
            if (seq[seq.length - 1] !== rule.tag) {
              seq.push(rule.tag);
            }
            break;
          }
        }
      }
      return seq;
    }

    function emotionMatch(seqA, seqB) {
      const len = Math.min(seqA.length, seqB.length);
      if (len < 3) return 0; // must have at least 3 aligned stages
      let matches = 0;
      for (let i = 0; i < len; i++) {
        if (seqA[i] === seqB[i]) matches++;
      }
      return matches / len;
    }

    function jaccardOverlap(a, b) {
      const setA = new Set(a);
      const setB = new Set(b);
      let inter = 0;
      for (const x of setA) if (setB.has(x)) inter++;
      const minSize = Math.min(setA.size, setB.size);
      if (minSize === 0) return 0;
      return inter / minSize;
    }

    function computeMatch(tmText) {
      const tmTokens = tokenize(tmText);
      if (tmTokens.length < 5) return null; // ignore short TM completely

      const tmBigrams = toBigrams(tmTokens);
      const tmEmotions = extractEmotionSeq(tmText);

      let best = null;

      for (const mem of bmStore) {
        if (mem.kind === "small-talk") continue;
        const memTokens = tokenize(mem.text || "");
        if (memTokens.length < 5) continue;

        const memBigrams = toBigrams(memTokens);
        const memEmotions = extractEmotionSeq(mem.text || "");

        const wordScore = jaccardOverlap(tmTokens, memTokens); // 0‚Äì1
        const patternScore = jaccardOverlap(tmBigrams, memBigrams); // 0‚Äì1
        const emotionScore = emotionMatch(tmEmotions, memEmotions); // 0‚Äì1

        // Weighted blend
        const total = 0.5 * wordScore + 0.2 * patternScore + 0.3 * emotionScore;

        if (!best || total > best.score) {
          best = {
            score: total,
            wordScore,
            patternScore,
            emotionScore,
            memory: mem
          };
        }
      }

      // Dead-zone: if total < 0.40, treat as "no match at all"
      if (!best || best.score < 0.40) return null;
      return best;
    }

    // ===== E0 + Reaction =====
    const polarityDisplay = document.getElementById("polarityDisplay");
    const toneDisplay = document.getElementById("toneDisplay");
    const reactionText = document.getElementById("reactionText");

    function updateReaction(tmText) {
      // Simple fake E0 update: length & sentiment keywords
      const tokens = tokenize(tmText);
      let pos = 0, neg = 0;
      const posWords = ["happy","hope","kind","love","joy","calm","peace","clever"];
      const negWords = ["sad","angry","upset","hate","fear","worried","tired","lonely","thirsty","disappoint","frustrated"];

      for (const t of tokens) {
        if (posWords.some(w => t.startsWith(w))) pos++;
        if (negWords.some(w => t.startsWith(w))) neg++;
      }
      const total = pos + neg || 1;
      const posRatio = pos / total;
      const negRatio = neg / total;
      E0 = Math.tanh(posRatio - negRatio); // -1..+1

      const posPct = Math.round((posRatio) * 100);
      const negPct = 100 - posPct;

      polarityDisplay.textContent = `Polarity: ${E0 >= 0 ? "Positive" : "Negative"} ¬∑ ${posPct} : ${negPct}`;

      let tone;
      if (Math.abs(E0) < 0.2) {
        tone = "Light, gentle, low-amplitude positive drift.";
      } else if (E0 > 0.5) {
        tone = "Soft, stabilizing, hopeful resonance.";
      } else if (E0 < -0.5) {
        tone = "Heavy, contracting, high-amplitude negative stress.";
      } else {
        tone = "Balanced but emotionally significant drift.";
      }
      toneDisplay.textContent = `Tone: ${tone}`;

      const line = `I've received your TM event and collided it with the current BM state. E‚ÇÄ is now around ${E0.toFixed(2)} (range ‚àí1 to +1). The more clearly you describe context, the stronger and cleaner your BM trace becomes.`;
      reactionText.textContent = line;
    }

    // ===== Match Banner + Auto-Recall Modal =====
    const matchBanner = document.getElementById("matchBanner");
    const matchText = document.getElementById("matchText");
    const openMatchBtn = document.getElementById("openMatchBtn");

    function hideMatchBanner() {
      matchBanner.style.display = "none";
      lastMatch = null;
    }

    function showMatchBanner(match) {
      lastMatch = match;
      const pct = Math.round(match.score * 100);
      matchText.textContent = `Related memory ~${pct}% match. Open previous topic?`;
      matchBanner.style.display = "flex";

      // If very strong (‚â• 70%), also open auto-recall modal
      if (pct >= 70) {
        openRecallModal(match);
      }
    }

    function openRecallModal(match) {
      const modal = document.getElementById("recallModal");
      const body = document.getElementById("recallModalBody");
      const pct = Math.round(match.score * 100);
      const day = new Date().toISOString().slice(0,10);

      const polarityText = E0 >= 0 ? "Positive" : "Negative";
      const posPct = E0 >= 0 ? Math.round((E0 + 1)/2 * 100) : Math.round((1 - (E0+1)/2) * 100);
      const negPct = 100 - posPct;

      body.textContent =
`Day: ${day} ¬∑ Match ‚âà ${pct}%

Polarity: ${polarityText} ¬∑ E‚ÇÄ‚âà${E0.toFixed(2)}
Polarity split: ${posPct} : ${negPct}

Title: ${match.memory.title || "Untitled memory"}

${match.memory.text.trim()}`;

      modal.style.display = "flex";
    }

    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    }

    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", e => {
        const id = btn.getAttribute("data-close");
        if (id) closeModal(id);
      });
    });

    openMatchBtn.addEventListener("click", () => {
      if (!lastMatch) return;
      openRecallModal(lastMatch);
    });

    // ===== Small Talk Detection & Recycle =====
    function isGreeting(text) {
      const t = text.toLowerCase().trim();
      return (
        t === "hi" || t === "hello" || t === "hey" ||
        t.startsWith("how are you") ||
        t.startsWith("salam") || t.startsWith("assalam")
      );
    }

    function isSmallTalk(text) {
      if (isGreeting(text)) return true;
      if (text.length < 80) return true;
      return false;
    }

    function pushRecycle(userText, botText) {
      const entry = {
        id: "r-" + Date.now(),
        at: nowIso(),
        user: userText,
        bot: botText
      };
      recycleStore.push(entry);
      // keep only last 48h
      const cutoff = Date.now() - (48 * 60 * 60 * 1000);
      recycleStore = recycleStore.filter(e => new Date(e.at).getTime() >= cutoff);
      saveJson(RECYCLE_KEY, recycleStore);
    }

    // ===== BM Save =====
    function saveBMEvent(userText, botText) {
      const entry = {
        id: "bm-" + Date.now(),
        title: summarizeTitle(userText),
        createdAt: nowIso(),
        kind: "story",
        text: botText ? (userText + "\n\n" + botText) : userText
      };
      bmStore.push(entry);
      // optional: cap BM size
      if (bmStore.length > 200) bmStore.shift();
      saveJson(BM_KEY, bmStore);
    }

    function summarizeTitle(text) {
      const tokens = tokenize(text);
      if (tokens.length === 0) return "Memory";
      return tokens.slice(0,4).map(w => w[0].toUpperCase()+w.slice(1)).join(" ");
    }

    // ===== BM Viewer =====
    const bmModalBody = document.getElementById("bmModalBody");
    document.getElementById("btnBmViewer").addEventListener("click", () => {
      if (bmStore.length === 0) {
        bmModalBody.textContent = "No BM entries yet.";
      } else {
        bmModalBody.textContent = bmStore
          .slice()
          .reverse()
          .map(m => `‚Ä¢ ${m.title || "Untitled"}  (${shortDateTime(m.createdAt)})\n${(m.text||"").trim()}\n`)
          .join("\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n");
      }
      document.getElementById("bmModal").style.display = "flex";
    });

    // ===== Recycle Viewer =====
    const recycleBody = document.getElementById("recycleModalBody");
    document.getElementById("btnRecycle").addEventListener("click", () => {
      if (recycleStore.length === 0) {
        recycleBody.textContent = "Recycle buffer is empty. Small talk from the last 48 hours will appear here.";
      } else {
        recycleBody.textContent = recycleStore
          .slice()
          .reverse()
          .map(e =>
            `${shortDateTime(e.at)}\nUser: ${e.user}\nAURA-X Œ©: ${e.bot}\n`
          ).join("\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n");
      }
      document.getElementById("recycleModal").style.display = "flex";
    });

    // ===== Recall BM Button (quick recall: last BM) =====
    document.getElementById("btnRecall").addEventListener("click", () => {
      if (bmStore.length === 0) return;
      const last = bmStore[bmStore.length - 1];
      openRecallModal({ score: 1, memory: last });
    });

    // ===== Voice Toggle (UI only) =====
    const voiceToggle = document.getElementById("voiceToggle");
    const voiceLabel = document.getElementById("voiceToggleLabel");
    voiceToggle.addEventListener("click", () => {
      voiceOn = !voiceOn;
      voiceLabel.textContent = voiceOn ? "Voice: On" : "Voice: Off";
    });

    // ===== Send Handling =====
    const tmInput = document.getElementById("tmInput");
    const sendBtn = document.getElementById("sendBtn");

    function handleSend() {
      const text = tmInput.value.trim();
      if (!text) return;
      tmInput.value = "";
      hideMatchBanner();

      addMessage("User", "TM event", text);

      // 1) Update E0 & reaction
      updateReaction(text);

      // 2) Bot reaction
      const botLine = "I'm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?";
      addMessage("AURA-X Œ©", "Reaction", botLine);

      // 3) Save either to recycle or BM
      if (isSmallTalk(text)) {
        pushRecycle(text, botLine);
      } else {
        saveBMEvent(text, botLine);
      }

      // 4) Auto BM‚ÄìTM match (only for non-small-talk TM)
      const match = computeMatch(text);
      if (match) {
        showMatchBanner(match);
      }
    }

    sendBtn.addEventListener("click", handleSend);
    tmInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ===== Init: seed greeting =====
    addMessage("AURA-X Œ©", "System", "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).");
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #4b5563;
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      border: none;
    }

    .chip-primary {
      background: #d1fae5;
      color: #065f46;
    }

    .warning-card {
      background: #fef3c7;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.4;
      border: 1px solid #fde68a;
    }

    .equation-card {
      margin-top: 8px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      line-height: 1.5;
    }
    .equation-title {
      font-weight: 600;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }
    .equation-body {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .reaction-card {
      margin-top: 8px;
      background: #ecfdf5;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #bbf7d0;
      font-size: 12px;
      line-height: 1.4;
    }
    .reaction-header {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .reaction-meta {
      font-size: 11px;
      color: #047857;
    }

    .thread {
      flex: 1;
      margin-top: 8px;
      padding: 8px 4px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fefcf7;
      overflow-y: auto;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .msg {
      max-width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .msg.user { align-items: flex-end; }
    .msg.bot  { align-items: flex-start; }

    .msg-label {
      font-size: 10px;
      color: #6b7280;
    }

    .msg-body {
      padding: 6px 8px;
      border-radius: 10px;
      background: #e5e7eb;
      white-space: pre-wrap;
    }
    .msg.user .msg-body {
      background: #d1fae5;
      align-self: flex-end;
    }

    .tm-equation {
      margin-top: 8px;
      font-size: 11px;
      text-align: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .input-row {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      align-items: flex-end;
    }

    .tm-input {
      flex: 1;
      min-height: 52px;
      max-height: 140px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      resize: vertical;
      background: #fff7ed;
    }

    .send-btn {
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: #16a34a;
      color: white;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.4);
    }

    .match-banner {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #fef9c3;
      border: 1px solid #facc15;
      font-size: 11px;
      display: none;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .match-open-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 11px;
      cursor: pointer;
    }

    .footer-row {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: #6b7280;
    }

    .voice-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-size: 11px;
    }

    .pill-soft {
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 10px;
    }

    /* small icon-ish buttons for top row */
    .top-btn {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-row">
      <div>EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN</div>
      <div class="pill-soft">LLM Engine: Live emotional reactor</div>
    </div>

    <div class="chip-row">
      <button class="chip top-btn" id="bmViewerBtn">üß† BM Viewer</button>
      <button class="chip top-btn" id="recallBtn">üìú Recall BM</button>
      <button class="chip top-btn" id="recycleBtn">‚ôªÔ∏è Recycle 48h</button>
      <button class="chip top-btn" id="optionsBtn">‚öôÔ∏è Options</button>
    </div>

    <div class="warning-card">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <div class="equation-card">
      <div class="equation-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation-body">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£Œ∂‚Çú)
      </div>
      <div style="font-size: 11px;">
        All parameters are being updated internally after every message
        to keep emotional continuity live.
      </div>
    </div>

    <div class="reaction-card">
      <div class="reaction-header">AURA-X Œ© REACTION</div>
      <div class="reaction-meta" id="polarityLabel">
        Polarity: Positive ¬∑ 58 : 42
      </div>
      <div id="reactionText">
        Tone: Light, gentle, low-amplitude positive drift.
      </div>
    </div>

    <div id="thread" class="thread">
      <!-- conversation messages go here -->
    </div>

    <div class="tm-equation">
      TM = Œ£(User Inputs) + (Seed + LLM)
    </div>

    <div class="input-row">
      <textarea id="tmInput" class="tm-input"
        placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>

    <div id="matchBanner" class="match-banner">
      <div id="matchText">Related memory ~0% match.</div>
      <button id="openMatchBtn" class="match-open-btn">Open</button>
    </div>

    <div class="footer-row">
      <div>Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.</div>
      <button id="voiceToggle" class="voice-toggle">
        <span id="voiceLabel">Voice: On</span>
      </button>
    </div>
  </div>

  <script>
    // ===== one-time migration: clear old AURA-X localStorage (small-talk BM etc.) =====
    try {
      if (!localStorage.getItem("aura_x_migration_v1_done")) {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (!k) continue;
          if (k.toLowerCase().includes("aura") || k.toLowerCase().includes("bm")) {
            keys.push(k);
          }
        }
        keys.forEach(k => localStorage.removeItem(k));
        localStorage.setItem("aura_x_migration_v1_done", "1");
      }
    } catch (e) {
      console.error("Migration error", e);
    }

    // ===== Utilities =====
    function tokenize(text) {
      return (text || "")
        .toLowerCase()
        .replace(/[^a-z0-9\s]+/g, " ")
        .split(/\s+/)
        .filter(t => t.length > 2);
    }

    function sentenceCount(text) {
      return (text.split(/[.!?]/).filter(s => s.trim().length > 0)).length;
    }

    function jaccardOverlap(aTokens, bTokens) {
      const a = new Set(aTokens);
      const b = new Set(bTokens);
      if (a.size === 0 || b.size === 0) return 0;
      let inter = 0;
      for (const t of a) if (b.has(t)) inter++;
      return inter / (a.size + b.size - inter);
    }

    function toBigrams(tokens) {
      const bigrams = [];
      for (let i = 0; i < tokens.length - 1; i++) {
        bigrams.push(tokens[i] + " " + tokens[i+1]);
      }
      return bigrams;
    }

    function extractEmotionSeq(text) {
      const t = (text || "").toLowerCase();
      const seq = [];
      if (t.includes("hope") || t.includes("hoping")) seq.push("hope");
      if (t.includes("thirsty") || t.includes("tired") || t.includes("hungry")) seq.push("need");
      if (t.includes("disappoint") || t.includes("sad")) seq.push("sad");
      if (t.includes("angry") || t.includes("frustrat")) seq.push("frustration");
      if (t.includes("idea") || t.includes("plan")) seq.push("insight");
      if (t.includes("rise") || t.includes("success") || t.includes("achieve")) seq.push("progress");
      if (t.includes("happy") || t.includes("satisfy") || t.includes("relief")) seq.push("relief");
      return seq;
    }

    function emotionMatch(seqA, seqB) {
      if (!seqA.length || !seqB.length) return 0;
      const setA = new Set(seqA);
      const setB = new Set(seqB);
      let inter = 0;
      for (const x of setA) if (setB.has(x)) inter++;
      return inter / (setA.size + setB.size - inter);
    }

    // ===== Deep story detection (BM save eligibility) =====
    function isDeepStory(text) {
      const tokens = tokenize(text);
      const words = tokens.length;
      const sents = sentenceCount(text);

      // size check (story / strong memory)
      if (words < 150 && sents < 20) return false;

      // meaningless repetition filter
      const unique = new Set(tokens).size;
      const uniqueRatio = unique / words;
      if (uniqueRatio < 0.4) return false;

      return true;
    }

    // ===== TM eligibility for matching =====
    function tmEligible(text) {
      const tokens = tokenize(text);
      const words = tokens.length;
      const sents = sentenceCount(text);
      if (words < 40 && sents < 10) return false;
      return true;
    }

    // ===== BM storage =====
    const BM_KEY = "aura_x_bm_v3";

    function cleanBMStore(store) {
      return (store || [])
        .filter(e => e && e.text && isDeepStory(e.text))
        .map(e => ({ ...e, kind: "user-story" }));
    }

    function loadBM() {
      try {
        const raw = localStorage.getItem(BM_KEY);
        if (!raw) return [];
        let store = JSON.parse(raw) || [];
        store = cleanBMStore(store);
        saveBM(store);
        return store;
      } catch (e) {
        console.error("BM load error", e);
        return [];
      }
    }

    function saveBM(store) {
      try {
        localStorage.setItem(BM_KEY, JSON.stringify(store));
      } catch (e) {
        console.error("BM save error", e);
      }
    }

    let bmStore = loadBM();

    // ===== Recycle buffer (48h concept) =====
    let recycleBuffer = [];

    function pushRecycle(userText, botText) {
      recycleBuffer.push({
        ts: Date.now(),
        userText,
        botText
      });
      if (recycleBuffer.length > 100) recycleBuffer.shift();
    }

    // ===== Save BM event (only deep stories) =====
    function saveBMEvent(text, botSummary) {
      if (!isDeepStory(text)) return null;

      const now = new Date();
      const id = "bm_" + now.getTime() + "_" + Math.random().toString(36).slice(2, 8);

      const entry = {
        id,
        kind: "user-story",
        date: now.toISOString(),
        text,
        summary: botSummary || "",
        polarity: { pos: 0.8, neg: 0.2 },
        layers: { L1:58, L2:44, L3:50, L4:42, L5:60, L6:45, L7:70 }
      };

      bmStore.push(entry);
      saveBM(bmStore);
      return entry;
    }

    // ===== Matching engine (TM vs BM) =====
    function computeMatch(tmText) {
      if (!tmEligible(tmText)) return null;

      const tmTokens = tokenize(tmText);
      const tmBigrams = toBigrams(tmTokens);
      const tmEmotions = extractEmotionSeq(tmText);

      let best = null;

      for (const mem of bmStore) {
        if (!mem || mem.kind !== "user-story") continue;

        const memTokens = tokenize(mem.text || "");
        if (memTokens.length < 40 && sentenceCount(mem.text || "") < 10) continue;

        const memBigrams = toBigrams(memTokens);
        const memEmotions = extractEmotionSeq(mem.text || "");

        const wordScore = jaccardOverlap(tmTokens, memTokens);
        const patternScore = jaccardOverlap(tmBigrams, memBigrams);
        const emotionScore = emotionMatch(tmEmotions, memEmotions);

        const total = 0.5 * wordScore + 0.2 * patternScore + 0.3 * emotionScore;

        if (!best || total > best.score) {
          best = { score: total, wordScore, patternScore, emotionScore, memory: mem };
        }
      }

      if (!best || best.score < 0.40) return null;
      return best;
    }

    // ===== UI handles =====
    const threadEl      = document.getElementById("thread");
    const tmInput       = document.getElementById("tmInput");
    const sendBtn       = document.getElementById("sendBtn");
    const matchBanner   = document.getElementById("matchBanner");
    const matchTextEl   = document.getElementById("matchText");
    const openMatchBtn  = document.getElementById("openMatchBtn");
    const bmViewerBtn   = document.getElementById("bmViewerBtn");
    const recycleBtn    = document.getElementById("recycleBtn");
    const recallBtn     = document.getElementById("recallBtn");
    const optionsBtn    = document.getElementById("optionsBtn");
    const voiceToggle   = document.getElementById("voiceToggle");
    const voiceLabel    = document.getElementById("voiceLabel");
    const polarityLabel = document.getElementById("polarityLabel");
    const reactionText  = document.getElementById("reactionText");

    let lastMatch = null;
    let voiceOn   = true;

    function addMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = "msg " + (role === "user" ? "user" : "bot");

      const label = document.createElement("div");
      label.className = "msg-label";
      label.textContent = role === "user" ? "You ¬∑ TM" : "AURA-X Œ©";

      const body = document.createElement("div");
      body.className = "msg-body";
      body.textContent = text;

      msg.appendChild(label);
      msg.appendChild(body);
      threadEl.appendChild(msg);
      threadEl.scrollTop = threadEl.scrollHeight;
    }

    function fakeBotReply(userText) {
      const t = userText.toLowerCase();
      if (/hello/.test(t)) {
        return "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).";
      }
      if (/who created/i.test(userText)) {
        return "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.";
      }
      if (/how are you/i.test(userText)) {
        return "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?";
      }
      return "I‚Äôve received your TM event and collided it with the current BM state. The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
    }

    function updateReactionCard() {
      polarityLabel.textContent = "Polarity: Positive ¬∑ 58 : 42";
      reactionText.textContent  = "Tone: Light, gentle, low-amplitude positive drift.";
    }

    function showMatchBanner(match) {
      if (!match) {
        matchBanner.style.display = "none";
        lastMatch = null;
        return;
      }
      lastMatch = match;
      const pct = Math.round(match.score * 100);
      matchTextEl.textContent =
        `Related memory ~${pct}% match. Open previous story?`;
      matchBanner.style.display = "flex";
    }

    // ===== send handler =====
    sendBtn.addEventListener("click", () => {
      const text = tmInput.value.trim();
      if (!text) return;

      addMessage("user", text);
      tmInput.value = "";

      const bot = fakeBotReply(text);
      addMessage("bot", bot);
      updateReactionCard();

      const saved = saveBMEvent(text, bot);
      if (saved) {
        const match = computeMatch(text);
        showMatchBanner(match);
      } else {
        pushRecycle(text, bot);
        showMatchBanner(null);
      }
    });

    tmInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    openMatchBtn.addEventListener("click", () => {
      if (!lastMatch) return;
      const mem = lastMatch.memory;
      addMessage("bot", "üìú Recalling BM story:\n" + (mem.text || ""));
      matchBanner.style.display = "none";
    });

    bmViewerBtn.addEventListener("click", () => {
      bmStore = loadBM();
      if (!bmStore.length) {
        alert("No Bold Memory (BM) deep stories saved yet.");
        return;
      }
      const lines = bmStore.map(m => {
        const d = new Date(m.date).toLocaleString();
        return `‚Ä¢ ${d}\n  ${ (m.text || "").slice(0, 160) }‚Ä¶`;
      }).join("\n\n");
      alert("BM NODES (deep stories only):\n\n" + lines);
    });

    recycleBtn.addEventListener("click", () => {
      if (!recycleBuffer.length) {
        alert("Recycle buffer is empty.\nSmall talk decays automatically within ~48 hours.");
        return;
      }
      const lines = recycleBuffer.slice(-10).map(r => {
        const d = new Date(r.ts).toLocaleTimeString();
        return `‚Ä¢ [${d}] ${r.userText.slice(0, 80)}‚Ä¶`;
      }).join("\n\n");
      alert("Recent Recycle 48h items:\n\n" + lines);
    });

    recallBtn.addEventListener("click", () => {
      if (!bmStore.length) {
        alert("There are no deep BM stories yet. Paste a full story or life event first.");
        return;
      }
      const last = bmStore[bmStore.length - 1];
      addMessage("bot", "Last saved BM story:\n" + (last.text || ""));
    });

    optionsBtn.addEventListener("click", () => {
      if (confirm("Clear all Bold Memory (BM) stories and recycle buffer?")) {
        bmStore = [];
        saveBM(bmStore);
        recycleBuffer = [];
        alert("All local BM and recycle data cleared from this browser.");
      }
    });

    voiceToggle.addEventListener("click", () => {
      voiceOn = !voiceOn;
      voiceLabel.textContent = voiceOn ? "Voice: On" : "Voice: Off";
    });

    // initial
    updateReactionCard();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .brand-title {
      font-weight: 700;
      font-size: 17px;
      letter-spacing: 0.02em;
    }
    .brand-sub {
      font-size: 11px;
      color: #4b5563;
    }
    .pill-engine {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      background: #e0f2fe;
      color: #0f172a;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 130px;
    }
    .pill-engine span:first-child {
      font-weight: 600;
      font-size: 11px;
    }
    .pill-engine span:last-child {
      font-size: 10px;
    }

    /* BM buttons row */
    .bm-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .bm-btn {
      flex: 1 1 0;
      min-width: 80px;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.18);
      background: #e5e7eb;
      color: #111827;
    }
    .bm-btn span {
      font-size: 14px;
    }
    .bm-btn-pink { background: #fee2e2; }
    .bm-btn-gold { background: #fef3c7; }
    .bm-btn-green { background: #dcfce7; }
    .bm-btn-gray { background: #e5e7eb; }

    /* Equation card */
    .equation-card {
      border-radius: 16px;
      padding: 12px;
      border: 1px dashed #d1d5db;
      background: #fefce8;
      font-size: 12px;
      line-height: 1.4;
    }
    .equation-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 4px;
    }
    .equation-main {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .equation-sub {
      font-size: 11px;
      color: #6b7280;
    }

    /* Guidance banner */
    .guidance-banner {
      border-radius: 16px;
      padding: 12px;
      background: #fef3c7;
      font-size: 12px;
      line-height: 1.4;
      border: 1px dashed #fbbf24;
    }

    /* Reaction card */
    .reaction-card {
      border-radius: 16px;
      padding: 10px 12px;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      font-size: 12px;
      line-height: 1.4;
    }
    .reaction-header {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .reaction-meta {
      font-size: 11px;
      color: #166534;
      margin-bottom: 4px;
    }

    /* Messages area */
    .messages {
      flex: 1;
      overflow-y: auto;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 6px;
      background: #fff7ed;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }
    .msg {
      padding-bottom: 4px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .msg:last-child {
      border-bottom: none;
    }
    .msg-author {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .msg-author span:last-child {
      font-weight: 500;
      color: #6b7280;
      font-size: 10px;
    }
    .msg-text {
      white-space: pre-wrap;
    }

    /* TM input area */
    .tm-equation-label {
      margin-top: 8px;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
      text-align: center;
      color: #111827;
    }
    .input-row {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .tm-input {
      flex: 1;
      border-radius: 16px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 13px;
      resize: none;
      min-height: 52px;
      max-height: 120px;
      background: #ffffff;
    }
    .send-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: #16a34a;
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.35);
      color: #ecfdf5;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    /* Bottom line */
    .footer-line {
      margin-top: 4px;
      font-size: 10px;
      color: #6b7280;
      text-align: center;
    }

    /* Voice toggle */
    .voice-toggle {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0f172a;
      align-self: flex-start;
      cursor: default;
    }
    .voice-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* Auto-recall banner */
    .recall-banner {
      margin-top: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      background: #fef3c7;
      border: 1px solid #facc15;
      font-size: 11px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .recall-banner span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .recall-open-btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: none;
      background: #2563eb;
      color: #eff6ff;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Modal base */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      max-height: 80vh;
      background: #f9fafb;
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(15,23,42,0.45);
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-title {
      font-size: 13px;
      font-weight: 600;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      background: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }
    .modal-body {
      font-size: 12px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .bm-layer-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
      font-size: 10px;
    }
    .chip {
      border-radius: 999px;
      padding: 2px 6px;
      background: #e5e7eb;
    }
    .bm-entry {
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .bm-entry:last-child { border-bottom: none; }
    .bm-entry-title {
      font-weight: 600;
      font-size: 12px;
    }
    .bm-entry-meta {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
    }
    .bm-entry-text {
      margin-top: 4px;
      white-space: pre-wrap;
    }
    .bm-copy-btn {
      border-radius: 999px;
      border: none;
      padding: 3px 8px;
      font-size: 10px;
      background: #dbeafe;
      color: #1d4ed8;
      cursor: pointer;
      margin-top: 4px;
    }

    /* Small helper classes */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header-top">
      <div class="brand-block">
        <div class="brand-title">AURA-X Œ© v1</div>
        <div class="brand-sub">
          EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥
        </div>
      </div>
      <div class="pill-engine">
        <span>LLM Engine</span>
        <span>Seed (local) ¬∑ Emotional reactor shell</span>
      </div>
    </div>

    <!-- BM / Options row -->
    <div class="bm-row">
      <button class="bm-btn bm-btn-pink" id="bmViewerBtn">
        <span>üß†</span> BM Viewer
      </button>
      <button class="bm-btn bm-btn-gold" id="bmRecallBtn">
        <span>üìú</span> Recall BM
      </button>
      <button class="bm-btn bm-btn-green" id="recycleBtn">
        <span>‚ôªÔ∏è</span> Recycle 48h
      </button>
      <button class="bm-btn bm-btn-gray" id="optionsBtn">
        <span>‚öôÔ∏è</span> Options
      </button>
    </div>

    <!-- Guidance banner -->
    <div class="guidance-banner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <!-- Equation card -->
    <div class="equation-card">
      <div class="equation-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation-main">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="equation-sub">
        All parameters are being updated internally after every message
        to keep emotional continuity live.
      </div>
    </div>

    <!-- Reaction -->
    <div class="reaction-card" id="reactionCard">
      <div class="reaction-header">AURA-X Œ© REACTION</div>
      <div class="reaction-meta" id="reactionMeta">
        Polarity: Neutral ¬∑ 50 : 50 ¬∑ Tone: Waiting for first TM event.
      </div>
      <div id="reactionText" class="reaction-text">
        Describe something real from your life. I will treat it as TM and
        start building BM layers around it.
      </div>
    </div>

    <!-- Messages log -->
    <div class="messages" id="messages"></div>

    <!-- TM equation label -->
    <div class="tm-equation-label">
      TM = Œ£(User Inputs) + (Seed + LLM)
    </div>

    <!-- Input row -->
    <div class="input-row">
      <textarea id="tmInput" class="tm-input"
        placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>

    <!-- Auto recall banner -->
    <div class="recall-banner" id="recallBanner">
      <span id="recallBannerText">üí° Related memory ~70% match.</span>
      <button class="recall-open-btn" id="recallOpenBtn">Open</button>
    </div>

    <!-- Voice toggle (UI only) -->
    <div class="voice-toggle">
      <div class="voice-dot"></div>
      <span>Voice: On (UI only ‚Äì no mic yet)</span>
    </div>

    <!-- Footer -->
    <div class="footer-line">
      Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="modal-backdrop" id="bmViewerModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">BM Viewer ¬∑ Stored Bold Memories</div>
        <button class="modal-close" data-close="bmViewerModal">Close</button>
      </div>
      <div class="modal-body" id="bmViewerBody"></div>
    </div>
  </div>

  <!-- Single BM recall modal -->
  <div class="modal-backdrop" id="bmRecallModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="bmRecallTitle">Auto-Recall Memory</div>
        <button class="modal-close" data-close="bmRecallModal">Close</button>
      </div>
      <div class="modal-body" id="bmRecallBody"></div>
    </div>
  </div>

  <!-- Recycle 48h modal -->
  <div class="modal-backdrop" id="recycleModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Recycle 48h ¬∑ Short chat traces</div>
        <button class="modal-close" data-close="recycleModal">Close</button>
      </div>
      <div class="modal-body" id="recycleBody"></div>
    </div>
  </div>

  <!-- Options modal -->
  <div class="modal-backdrop" id="optionsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Options ¬∑ System Settings</div>
        <button class="modal-close" data-close="optionsModal">Close</button>
      </div>
      <div class="modal-body" id="optionsBody">
        <p>
          This prototype runs fully in your browser using
          <strong>localStorage</strong>. No data is sent to a server.
        </p>
        <p style="margin-top:6px;">
          ‚Ä¢ TM messages longer than <strong>80 characters</strong> are candidates
          for Bold Memory (BM).<br/>
          ‚Ä¢ Short greetings are kept only in the <strong>Recycle 48h</strong> tray.<br/>
          ‚Ä¢ Auto-Recall triggers only when similarity with a stored BM story is
          ‚â• <strong>70%</strong> and at least <strong>4 meaningful words</strong> overlap.
        </p>
        <button class="bm-copy-btn" id="clearAllBtn" style="margin-top:8px;">
          üî• Clear all local BM & chat data
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // STORAGE KEYS & CONSTANTS
    // ============================
    const BM_STORAGE_KEY = "auraX_bm_v3";
    const CHAT_STORAGE_KEY = "auraX_chat_v3";
    const RECYCLE_STORAGE_KEY = "auraX_recycle48_v1";

    const SIM_THRESHOLD = 0.70;        // 70% minimum similarity
    const MIN_OVERLAP_TOKENS = 4;      // minimum meaningful shared words
    const MIN_BM_LENGTH = 80;          // characters to treat TM as BM candidate

    // Simple anti-noise stopwords (English only for now)
    const STOPWORDS = new Set([
      "the","and","for","with","that","this","from","have","will","would","could",
      "should","about","your","into","over","under","very","their","there","here",
      "been","then","than","when","what","where","which","such","many","some",
      "just","like","into","onto","ourselves","himself","herself","itself",
      "they","them","were","while","because","also","into","onto","once","ever",
      "only","after","before","again","more","most","much","even","every","each",
      "onto","ours","his","hers","its","our","are","was","you","but","why","who",
      "whose","how","can","may","might","shall","than","too","very","still"
    ]);

    // ============================
    // UTILITIES
    // ============================

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to load", key, e);
        return fallback;
      }
    }

    function saveJSON(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error("Failed to save", key, e);
      }
    }

    function tokenize(text) {
      if (!text) return new Set();
      const cleaned = text
        .toLowerCase()
        .replace(/[^a-z\s]+/g, " ")
        .split(/\s+/)
        .filter(w => w && w.length >= 4 && !STOPWORDS.has(w));
      return new Set(cleaned);
    }

    function nowIso() {
      return new Date().toISOString();
    }

    // ============================
    // STATE
    // ============================

    let bmStore = loadJSON(BM_STORAGE_KEY, []);
    let chatLog = loadJSON(CHAT_STORAGE_KEY, []);
    let recycleStore = loadJSON(RECYCLE_STORAGE_KEY, []);

    // Ensure tokens exist for old BM entries
    bmStore.forEach(entry => {
      if (!entry.tokens || !Array.isArray(entry.tokens)) {
        entry.tokens = Array.from(tokenize(entry.text || entry.summary || ""));
      }
    });
    saveJSON(BM_STORAGE_KEY, bmStore);

    let lastAutoRecallCandidate = null;

    // ============================
    // RENDER FUNCTIONS
    // ============================

    const messagesEl = document.getElementById("messages");
    const reactionMetaEl = document.getElementById("reactionMeta");
    const reactionTextEl = document.getElementById("reactionText");
    const recallBannerEl = document.getElementById("recallBanner");
    const recallBannerTextEl = document.getElementById("recallBannerText");

    function renderMessages() {
      messagesEl.innerHTML = "";
      chatLog.forEach(msg => {
        const div = document.createElement("div");
        div.className = "msg";
        const header = document.createElement("div");
        header.className = "msg-author";
        header.innerHTML = `<span>${msg.author}</span><span>${msg.time || ""}</span>`;
        const body = document.createElement("div");
        body.className = "msg-text";
        body.textContent = msg.text;
        div.appendChild(header);
        div.appendChild(body);
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderReaction(e0, polarity) {
      const pos = Math.round((polarity + 1) * 50); // -1..+1 -> 0..100
      const neg = 100 - pos;
      const tone =
        e0 > 0.5 ? "Soft, stabilizing, hopeful resonance."
      : e0 > 0.1 ? "Light, gentle, low-amplitude positive drift."
      : e0 > -0.1 ? "Currently near neutral. Still contributes to long-run BM layers."
      : e0 > -0.5 ? "Low-amplitude negative drift. Gently move toward stabilizing thoughts."
      : "High-amplitude negative drift. Slow down and ground yourself kindly.";

      reactionMetaEl.textContent =
        `Polarity: ${pos} : ${neg} ¬∑ Tone: ${tone}`;
      reactionTextEl.textContent =
        "I've received your TM event and collided it with the current BM state. " +
        `E‚ÇÄ is now around ${e0.toFixed(2)} (range ‚àí1 to +1). ` +
        "The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
    }

    function renderBMViewer() {
      const body = document.getElementById("bmViewerBody");
      if (!bmStore.length) {
        body.textContent = "No Bold Memories saved yet. Share deeper stories and they will appear here.";
        return;
      }
      body.innerHTML = "";
      const info = document.createElement("div");
      info.style.marginBottom = "6px";
      info.textContent = `Total BM entries: ${bmStore.length}`;
      body.appendChild(info);

      bmStore
        .slice()
        .sort((a,b) => (b.savedAt || "").localeCompare(a.savedAt || ""))
        .forEach(entry => {
          const wrap = document.createElement("div");
          wrap.className = "bm-entry";
          const title = document.createElement("div");
          title.className = "bm-entry-title";
          title.textContent = entry.title || "Untitled memory";
          const meta = document.createElement("div");
          meta.className = "bm-entry-meta";
          meta.textContent =
            `Layer: ${entry.layer || "L2+"} ¬∑ ` +
            `Polarity: ${entry.polarity || "Balanced"} ¬∑ ` +
            `Saved: ${entry.savedAt ? entry.savedAt.slice(0,16).replace("T"," ") : "unknown"}`;
          const text = document.createElement("div");
          text.className = "bm-entry-text";
          text.textContent = entry.text || "";
          const btn = document.createElement("button");
          btn.className = "bm-copy-btn";
          btn.textContent = "Copy prompt for LLM";
          btn.addEventListener("click", () => {
            const prompt = `Recall this BM story as emotional context:\n\n${entry.text || ""}`;
            navigator.clipboard.writeText(prompt).catch(() => {});
          });
          wrap.appendChild(title);
          wrap.appendChild(meta);
          wrap.appendChild(text);
          wrap.appendChild(btn);
          body.appendChild(wrap);
        });
    }

    function openModal(id) {
      document.getElementById(id).style.display = "flex";
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // ============================
    // RECYCLE 48H
    // ============================

    function cleanupRecycle() {
      const now = Date.now();
      const cutoff = now - 48 * 60 * 60 * 1000;
      recycleStore = recycleStore.filter(r => {
        try {
          return new Date(r.createdAt).getTime() >= cutoff;
        } catch {
          return false;
        }
      });
      saveJSON(RECYCLE_STORAGE_KEY, recycleStore);
    }

    function addToRecycle(text) {
      cleanupRecycle();
      recycleStore.push({ text, createdAt: nowIso() });
      saveJSON(RECYCLE_STORAGE_KEY, recycleStore);
    }

    function renderRecycle() {
      cleanupRecycle();
      const body = document.getElementById("recycleBody");
      if (!recycleStore.length) {
        body.textContent = "No recent short chats. New greetings will appear here for 48 hours.";
        return;
      }
      body.innerHTML = "";
      recycleStore
        .slice()
        .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
        .forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "bm-entry";
          const title = document.createElement("div");
          title.className = "bm-entry-title";
          title.textContent = `Trace #${idx + 1}`;
          const meta = document.createElement("div");
          meta.className = "bm-entry-meta";
          meta.textContent = `Time: ${item.createdAt.slice(0,16).replace("T"," ")}`;
          const text = document.createElement("div");
          text.className = "bm-entry-text";
          text.textContent = item.text;
          div.appendChild(title);
          div.appendChild(meta);
          div.appendChild(text);
          body.appendChild(div);
        });
    }

    // ============================
    // BM SAVE & AUTO-RECALL
    // ============================

    function saveBMFromTM(tmText, e0, polarity) {
      if (!tmText || tmText.length < MIN_BM_LENGTH) return;
      const tokensSet = tokenize(tmText);
      if (!tokensSet.size) return;
      const entry = {
        id: "bm_" + Date.now(),
        title: tmText.slice(0, 60) + (tmText.length > 60 ? "‚Ä¶" : ""),
        text: tmText,
        layer: "L2‚ÄìL3",
        polarity: polarity >= 0 ? "Positive" : "Negative",
        savedAt: nowIso(),
        tokens: Array.from(tokensSet)
      };
      bmStore.push(entry);
      saveJSON(BM_STORAGE_KEY, bmStore);
    }

    function computeSimilarity(tmTokens, bmTokensArr) {
      if (!tmTokens.size || !bmTokensArr || !bmTokensArr.length) return { similarity: 0, overlap: 0 };
      const bmSet = new Set(bmTokensArr);
      let overlap = 0;
      tmTokens.forEach(tok => {
        if (bmSet.has(tok)) overlap++;
      });
      const similarity = overlap / bmSet.size;
      return { similarity, overlap };
    }

    function runAutoRecall(tmText) {
      lastAutoRecallCandidate = null;
      recallBannerEl.style.display = "none";
      if (!bmStore.length || !tmText) return;

      const tmTokens = tokenize(tmText);
      if (!tmTokens.size) return;

      let best = null;

      bmStore.forEach(entry => {
        const { similarity, overlap } = computeSimilarity(tmTokens, entry.tokens || []);
        if (overlap < MIN_OVERLAP_TOKENS) return;
        if (similarity < SIM_THRESHOLD) return;
        if (!best || similarity > best.similarity) {
          best = { entry, similarity, overlap };
        }
      });

      if (best) {
        lastAutoRecallCandidate = best;
        const pct = Math.round(best.similarity * 100);
        recallBannerTextEl.textContent =
          `üí° Related memory ~${pct}% match. Open previous topic?`;
        recallBannerEl.style.display = "flex";
      }
    }

    function openAutoRecallModal() {
      if (!lastAutoRecallCandidate) return;
      const { entry, similarity, overlap } = lastAutoRecallCandidate;
      const body = document.getElementById("bmRecallBody");
      const titleEl = document.getElementById("bmRecallTitle");
      const pct = Math.round(similarity * 100);

      titleEl.textContent = `Auto-Recall Memory ¬∑ Match ‚âà ${pct}%`;

      body.innerHTML = "";
      const meta = document.createElement("div");
      meta.className = "bm-entry-meta";
      meta.textContent =
        `Positive polarity (approx.) ¬∑ Overlap tokens: ${overlap} ¬∑ ` +
        `Saved: ${entry.savedAt.slice(0,16).replace("T"," ")}`;
      const text = document.createElement("div");
      text.className = "bm-entry-text";
      text.textContent = entry.text;
      body.appendChild(meta);
      body.appendChild(text);
      openModal("bmRecallModal");
    }

    // ============================
    // MAIN TM HANDLER
    // ============================

    const tmInputEl = document.getElementById("tmInput");
    const sendBtnEl = document.getElementById("sendBtn");

    function handleSend() {
      const tmText = tmInputEl.value.trim();
      if (!tmText) return;

      const timeStr = new Date().toTimeString().slice(0,5);

      // 1) Add user TM to chat log
      chatLog.push({ author: "User (TM)", text: tmText, time: timeStr });

      // 2) Simple emotional math (placeholder)
      const base = Math.max(-1, Math.min(1, (tmText.length - 80) / 300));
      const faith = 0.05;
      const sysBias = 0.02;
      const disturbance = 0.1;
      const e0raw = base - disturbance + faith + sysBias;
      const e0 = Math.tanh(e0raw);
      const polarityCore = e0; // -1..+1

      renderReaction(e0, polarityCore);

      // 3) Decide BM vs Recycle
      if (tmText.length < MIN_BM_LENGTH) {
        addToRecycle(tmText);
      } else {
        saveBMFromTM(tmText, e0, polarityCore);
      }

      // 4) Simple AURA-X Œ© response (seeded)
      const botReply =
        "I'm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. " +
        "How is your inner graph today?";
      chatLog.push({ author: "AURA-X Œ©", text: botReply, time: timeStr });

      // 5) Persist chat
      saveJSON(CHAT_STORAGE_KEY, chatLog);
      renderMessages();

      // 6) Run auto-recall with new TM
      runAutoRecall(tmText);

      // 7) Clear input
      tmInputEl.value = "";
    }

    sendBtnEl.addEventListener("click", handleSend);
    tmInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ============================
    // BUTTON HOOKS
    // ============================

    document.getElementById("bmViewerBtn").addEventListener("click", () => {
      renderBMViewer();
      openModal("bmViewerModal");
    });

    document.getElementById("bmRecallBtn").addEventListener("click", () => {
      // Manual recall: just open latest BM
      if (!bmStore.length) {
        const body = document.getElementById("bmRecallBody");
        document.getElementById("bmRecallTitle").textContent = "Recall BM";
        body.textContent = "No Bold Memories stored yet.";
        openModal("bmRecallModal");
        return;
      }
      const latest = bmStore[bmStore.length - 1];
      lastAutoRecallCandidate = {
        entry: latest,
        similarity: 1,
        overlap: latest.tokens ? latest.tokens.length : 0
      };
      openAutoRecallModal();
    });

    document.getElementById("recycleBtn").addEventListener("click", () => {
      renderRecycle();
      openModal("recycleModal");
    });

    document.getElementById("optionsBtn").addEventListener("click", () => {
      openModal("optionsModal");
    });

    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-close");
        if (id) closeModal(id);
      });
    });

    document.getElementById("recallOpenBtn").addEventListener("click", () => {
      openAutoRecallModal();
    });

    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if (!confirm("Are you sure you want to clear all BM, chat, and recycle data?")) return;
      bmStore = [];
      chatLog = [];
      recycleStore = [];
      saveJSON(BM_STORAGE_KEY, bmStore);
      saveJSON(CHAT_STORAGE_KEY, chatLog);
      saveJSON(RECYCLE_STORAGE_KEY, recycleStore);
      renderMessages();
      recallBannerEl.style.display = "none";
      alert("All local data cleared. Prototype has been reset.");
    });

    // ============================
    // INITIAL RENDER
    // ============================
    renderMessages();
    cleanupRecycle();
  </script>
</body>
</html>

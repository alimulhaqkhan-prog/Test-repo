<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title-main {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 0.04em;
    }
    .title-sub {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
    }
    .engine-pill {
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 10px;
      background: linear-gradient(135deg, #e0f2fe, #f5f3ff);
      color: #0369a1;
      border: 1px solid rgba(148, 163, 184, 0.4);
      text-align: right;
      line-height: 1.2;
    }
    .engine-pill span {
      display: block;
    }
    .engine-label {
      font-weight: 600;
      font-size: 11px;
    }

    /* Control buttons */
    .control-row {
      display: flex;
      gap: 8px;
      overflow-x: auto;
    }
    .chip-btn {
      flex: 0 0 auto;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #fefce8;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 1px 0 rgba(148, 163, 184, 0.3);
    }
    .chip-btn span.emoji {
      font-size: 14px;
    }

    /* Equation card */
    .card {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 250, 240, 0.9);
      padding: 12px;
      font-size: 12px;
      line-height: 1.4;
    }
    .card-title {
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .equation-text {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      margin-bottom: 6px;
    }

    /* Reaction card */
    .reaction-card {
      border-radius: 16px;
      border: 1px solid rgba(34, 197, 94, 0.4);
      background: #ecfdf3;
      padding: 10px 12px;
      font-size: 12px;
    }
    .reaction-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
      color: #166534;
    }
    .reaction-main {
      font-size: 12px;
      color: #14532d;
    }

    /* Thread */
    .thread {
      flex: 1;
      border-radius: 16px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: #fffbeb;
      padding: 10px 10px 4px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }
    .msg {
      max-width: 90%;
      line-height: 1.35;
    }
    .msg-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 1px;
    }
    .msg-body {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(209, 213, 219, 0.8);
      background: rgba(255, 255, 255, 0.9);
    }
    .msg.user {
      align-self: flex-end;
    }
    .msg.user .msg-body {
      background: #dcfce7;
      border-color: rgba(22, 163, 74, 0.6);
    }
    .msg.user .msg-label {
      text-align: right;
    }
    .msg.bot .msg-label {
      text-align: left;
    }

    /* Composer */
    .composer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 2px;
    }
    .tm-label {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: #6b7280;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .tm-input {
      flex: 1;
      min-height: 48px;
      max-height: 120px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: #fffbeb;
      resize: vertical;
      font-size: 13px;
      line-height: 1.3;
    }
    .send-btn {
      width: 72px;
      height: 40px;
      border-radius: 999px;
      border: none;
      background: #16a34a;
      color: #f9fafb;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(22, 163, 74, 0.8);
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    /* Match banner */
    .match-banner {
      margin-top: 2px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #fef9c3;
      border: 1px solid rgba(251, 191, 36, 0.9);
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .match-main {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .match-main span.emoji {
      font-size: 14px;
    }
    .match-text {
      font-size: 11px;
    }
    .match-open-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    /* Footer */
    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
      font-size: 10px;
      color: #9ca3af;
    }
    .voice-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: #eef2ff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 11px;
    }
    .voice-pill span.emoji {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header-top">
      <div class="title-block">
        <div class="title-main">AURA-X Œ©</div>
        <div class="title-sub">Emotional continuity ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</div>
      </div>
      <div class="engine-pill">
        <span class="engine-label">LLM</span>
        <span>Engine: Seed (local)</span>
      </div>
    </header>

    <div class="control-row">
      <button class="chip-btn" id="bmViewerBtn"><span class="emoji">üß†</span>BM Viewer</button>
      <button class="chip-btn" id="recallBtn"><span class="emoji">üìú</span>Recall BM</button>
      <button class="chip-btn" id="recycleBtn"><span class="emoji">‚ôªÔ∏è</span>Recycle 48h</button>
      <button class="chip-btn" id="optionsBtn"><span class="emoji">‚öôÔ∏è</span>Options</button>
    </div>

    <div class="card">
      <div class="card-title">Emotional Continuity Equation</div>
      <div class="equation-text">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div>
        All parameters are being updated internally after every message to keep emotional continuity live.
      </div>
    </div>

    <div class="reaction-card" id="reactionCard">
      <div class="reaction-header">
        <span>AURA-X Œ© REACTION</span>
        <span id="polarityLabel">Polarity: Positive ¬∑ 58 : 42</span>
      </div>
      <div class="reaction-main" id="reactionText">
        Tone: Light, gentle, low-amplitude positive drift.
      </div>
    </div>

    <div class="thread" id="thread"></div>

    <div class="composer">
      <div class="tm-label">TM = Œ£(User Inputs) + (Seed + LLM)</div>
      <div class="input-row">
        <textarea id="tmInput" class="tm-input" placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
      <div class="match-banner" id="matchBanner" style="display:none;">
        <div class="match-main">
          <span class="emoji">üí°</span>
          <div class="match-text" id="matchText">
            Related memory ~70% match. Open previous topic?
          </div>
        </div>
        <button class="match-open-btn" id="openMatchBtn">Open</button>
      </div>
    </div>

    <div class="footer-row">
      <div>Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.</div>
      <button class="voice-pill" id="voiceToggle">
        <span class="emoji">üéôÔ∏è</span>
        <span id="voiceLabel">Voice: On</span>
      </button>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    function tokenize(text) {
      return (text || "")
        .toLowerCase()
        .replace(/[^a-z0-9\s]+/g, " ")
        .split(/\s+/)
        .filter(t => t.length > 2);
    }

    function sentenceCount(text) {
      return (text.split(/[.!?]/).filter(s => s.trim().length > 0)).length;
    }

    // Jaccard overlap between sets/vocab
    function jaccardOverlap(aTokens, bTokens) {
      const a = new Set(aTokens);
      const b = new Set(bTokens);
      if (a.size === 0 || b.size === 0) return 0;
      let inter = 0;
      for (const t of a) if (b.has(t)) inter++;
      return inter / (a.size + b.size - inter);
    }

    function toBigrams(tokens) {
      const bigrams = [];
      for (let i = 0; i < tokens.length - 1; i++) {
        bigrams.push(tokens[i] + " " + tokens[i+1]);
      }
      return bigrams;
    }

    // Simple emotion sequence extractor (keywords ‚Üí labels)
    function extractEmotionSeq(text) {
      const t = (text || "").toLowerCase();
      const seq = [];
      if (t.includes("hope") || t.includes("hoping")) seq.push("hope");
      if (t.includes("thirsty") || t.includes("tired") || t.includes("hungry")) seq.push("need");
      if (t.includes("disappoint") || t.includes("sad")) seq.push("sad");
      if (t.includes("angry") || t.includes("frustrat")) seq.push("frustration");
      if (t.includes("idea") || t.includes("plan")) seq.push("insight");
      if (t.includes("rise") || t.includes("success") || t.includes("achieve")) seq.push("progress");
      if (t.includes("happy") || t.includes("satisfy") || t.includes("relief")) seq.push("relief");
      return seq;
    }

    function emotionMatch(seqA, seqB) {
      if (!seqA.length || !seqB.length) return 0;
      const setA = new Set(seqA);
      const setB = new Set(seqB);
      let inter = 0;
      for (const x of setA) if (setB.has(x)) inter++;
      return inter / (setA.size + setB.size - inter);
    }

    // ===== BM storage =====
    const BM_KEY = "aura_x_bm_v3";

    function loadBM() {
      try {
        const raw = localStorage.getItem(BM_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error("BM load error", e);
        return [];
      }
    }

    function saveBM(store) {
      try {
        localStorage.setItem(BM_KEY, JSON.stringify(store));
      } catch (e) {
        console.error("BM save error", e);
      }
    }

    let bmStore = loadBM();

    // ===== Recycle buffer (48h) ‚Äì simple stub =====
    let recycleBuffer = [];

    function pushRecycle(userText, botText) {
      recycleBuffer.push({
        ts: Date.now(),
        userText,
        botText
      });
      // soft cap
      if (recycleBuffer.length > 100) recycleBuffer.shift();
    }

    // ===== Deep story detection (BM save eligibility) =====
    function isDeepStory(text) {
      const tokens = tokenize(text);
      const words = tokens.length;
      const sents = sentenceCount(text);

      // Must be reasonably large
      if (words < 150 && sents < 20) return false;

      // Avoid meaningless repetition
      const unique = new Set(tokens).size;
      const uniqueRatio = unique / words;
      if (uniqueRatio < 0.4) return false;

      return true;
    }

    // ===== TM eligibility for matching =====
    function tmEligible(text) {
      const tokens = tokenize(text);
      const words = tokens.length;
      const sents = sentenceCount(text);
      if (words < 40 && sents < 10) return false;
      return true;
    }

    // ===== Save BM event =====
    function saveBMEvent(text, botSummary) {
      const now = new Date();
      const id = "bm_" + now.getTime() + "_" + Math.random().toString(36).slice(2, 8);

      const entry = {
        id,
        kind: "user-story", // only this kind participates in matching
        date: now.toISOString(),
        text,
        summary: botSummary || "",
        polarity: { pos: 0.8, neg: 0.2 }, // placeholder
        layers: {
          L1: 58, L2: 44, L3: 50, L4: 42, L5: 60, L6: 45, L7: 70
        }
      };

      bmStore.push(entry);
      saveBM(bmStore);
      return entry;
    }

    // ===== Matching engine (TM vs BM stories) =====
    function computeMatch(tmText) {
      // TM must be big / meaningful enough
      if (!tmEligible(tmText)) return null;

      const tmTokens = tokenize(tmText);
      const tmBigrams = toBigrams(tmTokens);
      const tmEmotions = extractEmotionSeq(tmText);

      let best = null;

      for (const mem of bmStore) {
        // Only user-story memories are eligible for recall
        if (mem.kind !== "user-story") continue;

        const memTokens = tokenize(mem.text || "");
        if (memTokens.length < 40 && sentenceCount(mem.text || "") < 10) continue;

        const memBigrams = toBigrams(memTokens);
        const memEmotions = extractEmotionSeq(mem.text || "");

        const wordScore = jaccardOverlap(tmTokens, memTokens);
        const patternScore = jaccardOverlap(tmBigrams, memBigrams);
        const emotionScore = emotionMatch(tmEmotions, memEmotions);

        const total = 0.5 * wordScore + 0.2 * patternScore + 0.3 * emotionScore;

        if (!best || total > best.score) {
          best = {
            score: total,
            wordScore,
            patternScore,
            emotionScore,
            memory: mem
          };
        }
      }

      // Dead zone: below 0.40 considered "no recall"
      if (!best || best.score < 0.40) return null;
      return best;
    }

    // ===== UI helpers =====
    const threadEl = document.getElementById("thread");
    const tmInput = document.getElementById("tmInput");
    const sendBtn = document.getElementById("sendBtn");
    const matchBanner = document.getElementById("matchBanner");
    const matchTextEl = document.getElementById("matchText");
    const openMatchBtn = document.getElementById("openMatchBtn");

    let lastMatch = null;

    function addMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = "msg " + (role === "user" ? "user" : "bot");

      const label = document.createElement("div");
      label.className = "msg-label";
      label.textContent = role === "user" ? "You ¬∑ TM" : "AURA-X Œ©";

      const body = document.createElement("div");
      body.className = "msg-body";
      body.textContent = text;

      msg.appendChild(label);
      msg.appendChild(body);
      threadEl.appendChild(msg);
      threadEl.scrollTop = threadEl.scrollHeight;
    }

    function fakeBotReply(userText) {
      // Simple deterministic stub ‚Äì real LLM will replace it later
      if (/hello/i.test(userText.trim())) {
        return "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).";
      }
      if (/who created/i.test(userText.toLowerCase())) {
        return "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.";
      }
      if (/how are you/i.test(userText.toLowerCase())) {
        return "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?";
      }
      return "I‚Äôve received your TM event and collided it with the current BM state. The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
    }

    function updateReactionCard() {
      // Placeholder, we just keep a gentle positive tone
      document.getElementById("polarityLabel").textContent =
        "Polarity: Positive ¬∑ 58 : 42";
      document.getElementById("reactionText").textContent =
        "Tone: Light, gentle, low-amplitude positive drift.";
    }

    function showMatchBanner(match) {
      if (!match) {
        matchBanner.style.display = "none";
        lastMatch = null;
        return;
      }
      lastMatch = match;
      const pct = Math.round(match.score * 100);
      matchTextEl.textContent =
        `Related memory ~${pct}% match. Open previous story?`;
      matchBanner.style.display = "flex";
    }

    // ===== Send handler =====
    sendBtn.addEventListener("click", () => {
      const text = tmInput.value.trim();
      if (!text) return;

      addMessage("user", text);
      tmInput.value = "";

      // Fake LLM response
      const bot = fakeBotReply(text);
      addMessage("bot", bot);
      updateReactionCard();

      // Decide whether to save as BM story or just recycle
      if (isDeepStory(text)) {
        const bmEntry = saveBMEvent(text, bot);
        const match = computeMatch(text);
        showMatchBanner(match);
      } else {
        pushRecycle(text, bot);
        showMatchBanner(null); // no recall for small talk
      }
    });

    tmInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Open matched BM story into thread
    openMatchBtn.addEventListener("click", () => {
      if (!lastMatch) return;
      const mem = lastMatch.memory;
      addMessage("bot", "üìú Recalling BM story:\n" + (mem.text || ""));
      matchBanner.style.display = "none";
    });

    // Simple BM viewer
    document.getElementById("bmViewerBtn").addEventListener("click", () => {
      bmStore = loadBM();
      if (!bmStore.length) {
        alert("No Bold Memory (BM) stories saved yet.");
        return;
      }
      const lines = bmStore.map(m => {
        const d = new Date(m.date).toLocaleString();
        const kind = m.kind || "unknown";
        return `‚Ä¢ [${kind}] ${d}\n  ${ (m.text || "").slice(0, 140) }‚Ä¶`;
      }).join("\n\n");
      alert("BM NODES:\n\n" + lines);
    });

    // Recycle viewer
    document.getElementById("recycleBtn").addEventListener("click", () => {
      if (!recycleBuffer.length) {
        alert("Recycle buffer is empty.\nSmall talk decays automatically within ~48 hours.");
        return;
      }
      const lines = recycleBuffer.slice(-10).map(r => {
        const d = new Date(r.ts).toLocaleTimeString();
        return `‚Ä¢ [${d}] ${r.userText.slice(0, 80)}‚Ä¶`;
      }).join("\n\n");
      alert("Recent Recycle 48h items:\n\n" + lines);
    });

    document.getElementById("recallBtn").addEventListener("click", () => {
      if (!bmStore.length) {
        alert("There are no deep BM stories yet. Paste a full story or life event first.");
        return;
      }
      const last = bmStore[bmStore.length - 1];
      addMessage("bot", "Last saved BM story:\n" + (last.text || ""));
    });

    document.getElementById("optionsBtn").addEventListener("click", () => {
      if (confirm("Clear all Bold Memory (BM) stories and recycle buffer?")) {
        bmStore = [];
        saveBM(bmStore);
        recycleBuffer = [];
        alert("All local BM and recycle data cleared from this browser.");
      }
    });

    // Voice toggle dummy
    const voiceToggle = document.getElementById("voiceToggle");
    const voiceLabel = document.getElementById("voiceLabel");
    let voiceOn = true;
    voiceToggle.addEventListener("click", () => {
      voiceOn = !voiceOn;
      voiceLabel.textContent = voiceOn ? "Voice: On" : "Voice: Off";
    });

    // Initial reaction
    updateReactionCard();
  </script>
</body>
</html>
